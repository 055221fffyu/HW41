<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="å°ˆæ¥­é…’é¡åƒ¹æ ¼æŸ¥è©¢ç³»çµ±ï¼Œæä¾›é…’ã€ç±³é…’ã€å•¤é…’ã€é«˜ç²±é…’ç­‰å„é¡é…’å“æ­·å²åƒ¹æ ¼è¶¨å‹¢ã€æ•¸æ“šçµ±è¨ˆåŠè³‡æ–™ç®¡ç†åŠŸèƒ½ã€‚è¼•é¬†æŸ¥è©¢èˆ‡æ–°å¢é…’åƒ¹ï¼ŒæŒæ¡å¸‚å ´å‹•æ…‹ã€‚">
  <title>é…’é¡åƒ¹æ ¼æŸ¥è©¢ç³»çµ± | Professional Alcohol Price System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    /* å…¨å±€è¨­å®š */
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#FAF9D9 0%,#f5ebe0 100%);min-height:100vh;color:#333;}
    .container{max-width:1400px;margin:0 auto;padding:20px;}

    /* é é¢æ¨™é¡Œå€å¡Š */
    .header{text-align:center;margin-bottom:40px;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-radius:20px;padding:30px;box-shadow:0 15px 30px rgba(0,0,0,.08);}
    .main-title{font-size:2.8rem;font-weight:700;background:linear-gradient(45deg,#A0522D,#FFC125);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;}
    .subtitle{color:#777;font-size:1.2rem;font-weight:300;}

    /* å„€è¡¨æ¿ç¶²æ ¼å¸ƒå±€ */
    .dashboard{display:grid;grid-template-columns:1fr;gap:30px;margin-bottom:40px;}

    /* å¡ç‰‡é€šç”¨æ¨£å¼ */
    .card{background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-radius:18px;padding:25px;box-shadow:0 12px 25px rgba(0,0,0,.07);transition:transform .3s ease,box-shadow .3s ease;}
    .card:hover{transform:translateY(-8px);box-shadow:0 20px 40px rgba(0,0,0,.12);}
    .card h2{color:#555;margin-bottom:20px;font-size:1.5rem;display:flex;align-items:center;gap:10px;}
    .card h2::before{content:'';width:4px;height:22px;background:linear-gradient(45deg,#A0522D,#FFC125);border-radius:2px;}

    /* è¡¨å–®å’Œè¡¨æ ¼é€šç”¨æ¨£å¼ */
    .form-table{width:100%;border-collapse:collapse;margin-bottom:15px;table-layout:fixed;}
    .form-table th,.form-table td{padding:12px 10px;border-bottom:1px solid #eee;text-align:center;}
    .form-table tr th:nth-child(1),.form-table tr td:nth-child(1){width:15%;}
    .form-table tr th:nth-child(2),.form-table tr td:nth-child(2){width:10%;}
    .form-table tr th:nth-child(3),.form-table tr td:nth-child(3),.form-table tr th:nth-child(4),.form-table tr td:nth-child(4),.form-table tr th:nth-child(5),.form-table tr td:nth-child(5),.form-table tr th:nth-child(6),.form-table tr td:nth-child(6),.form-table tr th:nth-child(7),.form-table tr td:nth-child(7){width:12%;}
    .form-table tr th:nth-child(8),.form-table tr td:nth-child(8){width:10%;}
    .form-table th{background:linear-gradient(45deg,#604020,#805030);color:white;font-weight:600;font-size:.95rem;border-radius:8px 8px 0 0;white-space:nowrap;}
    .form-table input,.form-table select{width:100%;padding:10px 8px;border:1px solid #dcdcdc;border-radius:8px;font-size:.9rem;transition:all .3s ease;min-width:0;}
    .form-table input:focus,.form-table select:focus{outline:none;border-color:#A0522D;box-shadow:0 0 0 3px rgba(160,82,45,.15);}

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn{background:linear-gradient(45deg,#CD853F,#EEE8AA);color:white;border:none;padding:12px 18px;border-radius:8px;font-weight:600;cursor:pointer;transition:all .3s ease;font-size:.95rem;white-space:nowrap;}
    .btn:hover{transform:translateY(-3px);box-shadow:0 12px 25px rgba(160,82,45,.3);}
    .btn-danger{background:linear-gradient(45deg,#e47d00,#ffb366);}
    .btn-danger:hover{box-shadow:0 12px 25px rgba(228,125,0,.3);}

    /* è¨Šæ¯æç¤ºæ¨£å¼ */
    .message{padding:12px 16px;border-radius:8px;margin:10px 0;font-weight:500;font-size:.9rem;}
    .message.success{background:rgba(144,238,144,.2);color:#2E8B57;border:1px solid rgba(46,139,87,.3);}
    .message.error{background:rgba(255,182,193,.2);color:#DC143C;border:1px solid rgba(220,20,60,.3);}
    .message.info{background:rgba(173,216,230,.2);color:#4682B4;border:1px solid rgba(70,130,180,.3);}


    /* åœ–è¡¨å€å¡Šæ¨£å¼ */
    .chart-section{grid-column:1/-1;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-radius:18px;padding:30px;box-shadow:0 15px 30px rgba(0,0,0,.07);margin-bottom:30px;}
    .chart-controls{display:flex;gap:15px;margin-bottom:25px;flex-wrap:wrap;align-items:center;}
    .chart-controls select{padding:10px 15px;border:1px solid #dcdcdc;border-radius:8px;font-size:.9rem;}
    .chart-alcohol-checkboxes{display:flex;flex-wrap:wrap;gap:20px;margin-top:20px;align-items:center;}
    .chart-alcohol-checkboxes label{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:1rem;font-weight:500;color:#444;}
    .chart-alcohol-checkboxes input[type="checkbox"]{-webkit-appearance:none;-moz-appearance:none;appearance:none;width:20px;height:20px;border:2px solid #999;border-radius:5px;cursor:pointer;display:inline-block;position:relative;transition:all .2s ease;}
    .chart-alcohol-checkboxes input[type="checkbox"]:checked{border-color:#A0522D;background-color:#A0522D;}
    .chart-alcohol-checkboxes input[type="checkbox"]:checked::before{content:'âœ“';display:block;color:white;font-size:16px;line-height:16px;text-align:center;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);}
    .chart-alcohol-checkboxes .color-box{width:18px;height:18px;border-radius:4px;display:inline-block;margin-right:6px;border:1px solid rgba(0,0,0,.1);}
    .chart-container{position:relative;height:450px;margin-bottom:20px;}

    /* è³‡æ–™è¡¨æ ¼å€å¡Šæ¨£å¼ */
    .data-table-section{grid-column:1/-1;}
    #pricesTable{width:100%;border-collapse:collapse;background:white;border-radius:12px;overflow:hidden;box-shadow:0 10px 25px rgba(0,0,0,.1);}
    #pricesTable th{background:linear-gradient(45deg,#604020,#805030);color:white;padding:16px 12px;font-weight:600;text-align:center;font-size:.95rem;}
    #pricesTable td{padding:14px;text-align:center;border-bottom:1px solid #f0f0f0;font-size:.9rem;}
    #pricesTable tr:hover{background:rgba(128,80,48,.05);}
    /* åˆªé™¤æŒ‰éˆ•éš±è— */
    #pricesTable td .delete-btn.hidden {
      display: none;
    }


    /* çµ±è¨ˆç¶²æ ¼æ¨£å¼ */
    .stats-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:25px;margin-bottom:30px;}
    .stat-card{background:rgba(255,255,255,.95);padding:25px;border-radius:15px;text-align:center;box-shadow:0 10px 25px rgba(0,0,0,.08);transition:transform .3s ease,box-shadow .3s ease;}
    .stat-card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,.15);}
    .stat-number{font-size:2.2rem;font-weight:700;color:#A0522D;margin-bottom:8px;}
    .stat-label{color:#666;font-size:.95rem;}

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width:768px){
      .stats-grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;}
      .main-title{font-size:2.2rem;}
      .subtitle{font-size:1rem;}
      .card h2{font-size:1.3rem;}
      .chart-controls{justify-content:center;}
      .form-table th,.form-table td{padding:8px 5px;font-size:.7rem;}
      .form-table input,.form-table select{font-size:.75rem;padding:6px 5px;}
      .btn{padding:8px 10px;font-size:.75rem;}
      .stat-number{font-size:1.8rem;}
      .stat-label{font-size:.85rem;}
      .chart-container{height:350px;}
      /* æ˜ç¢ºåˆ†éš”æŸ¥è©¢å’Œæ–°å¢é…’åƒ¹è³‡æ–™å¡ç‰‡ */
      .dashboard .card:nth-child(1) { /* ç¬¬ä¸€å€‹ card æ˜¯æŸ¥è©¢é…’åƒ¹è³‡æ–™ */
        margin-bottom: 30px; /* åœ¨æ‰‹æ©Ÿè¦–åœ–ä¸‹å¢åŠ åº•éƒ¨é–“è· */
      }
      /* ç¢ºä¿ data-table-section ä¹Ÿæœ‰é©ç•¶é–“è· */
      .data-table-section {
        margin-top: 30px;
      }
    }

    /* åŠ è¼‰å‹•ç•« */
    .loading{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #A0522D;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

    /* æ¨¡æ…‹æ¡†æ¨£å¼ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 450px;
      position: relative;
      text-align: center;
    }
    .modal-content h3 {
      margin-bottom: 20px;
      color: #333;
    }
    .close-button {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      cursor: pointer;
      color: #888;
    }
    .close-button:hover {
      color: #555;
    }
    .form-group {
      margin-bottom: 15px;
      text-align: left;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    .form-group input:focus {
      outline: none;
      border-color: #A0522D;
      box-shadow: 0 0 0 3px rgba(160,82,45,.15);}
    .modal-content .btn {
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      font-size: 1.1rem;}
    /* ä¿®æ”¹å¾Œçš„æç¤ºæ–‡å­—æ¨£å¼ */
    .prompt-text { /* ä½¿ç”¨æ›´é€šç”¨çš„é¡å */
      margin-top: 20px;
      font-size: 0.95rem;
      color: #666;
    }
    .action-link { /* ä½¿ç”¨æ›´é€šç”¨çš„é¡å */
      color: #A0522D; /* éˆæ¥é¡è‰²èˆ‡ä¸»é¡Œè‰²ä¿æŒä¸€è‡´ */
      font-weight: bold;
      text-decoration: none;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .action-link:hover {
      color: #CD853F;
      text-decoration: underline;
    }
    /* è³‡å®‰æç¤ºæ¨£å¼ */
    .security-note {
      font-size: 0.85rem;
      color: #888;
      margin-top: 25px;
      margin-bottom: 20px;
      line-height: 1.5;
    }


    .knowledge-section {
      margin-bottom: 30px;
    }
    /* é…’é¡çŸ¥è­˜å€å¡Šæ¨£å¼ */
    .knowledge-section h2 {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #555;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }
    .knowledge-section h2::before {
      content: 'ğŸ’¡'; /* å°ç‡ˆæ³¡åœ–æ¨™ */
      font-size: 1.3em; /* èª¿æ•´åœ–æ¨™å¤§å° */
      margin-right: 5px;
    }
    .knowledge-section .knowledge-content {
      min-height: 60px; /* ç¨æ¸›æœ€å°é«˜åº¦ï¼Œå¾ 80px èª¿æ•´ç‚º 60px */
      display: flex; /* ä½¿ç”¨ flexbox è®“å…§å®¹å‚ç›´å±…ä¸­ */
      align-items: center; /* å‚ç›´å±…ä¸­ */
      justify-content: center; /* æ°´å¹³å±…ä¸­ */
      text-align: center; /* ç¢ºä¿æ–‡æœ¬å±…ä¸­ */
    }
    .knowledge-section p {
      margin-bottom: 10px;
      line-height: 1.6;
      color: #666;
      opacity: 0; /* é è¨­éš±è—ï¼Œç”¨æ–¼éæ¸¡æ•ˆæœ */
      transition: opacity 0.5s ease-in-out; /* æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
    }
    .knowledge-section p.active {
      opacity: 1; /* é¡¯ç¤ºæ™‚æ·¡å…¥ */
    }

    /* é‡£é­šæ•™è‚²æ¨¡æ…‹æ¡†çš„æ¨£å¼ */
    .phishing-modal-content {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
      max-width: 600px;
      width: 90%;
      text-align: center;
      position: relative;
    }
    .phishing-modal-content h1 {
      color: #A0522D; /* èˆ‡ä¸»é¡Œè‰²ç›¸ç¬¦ */
      font-size: 2.2rem; /* ç¨å¾®ç¸®å°æ¨™é¡Œ */
      margin-bottom: 25px;
      font-weight: 700;
    }
    .phishing-modal-content p {
      font-size: 1.05rem; /* ç¨å¾®ç¸®å°æ–‡å­— */
      line-height: 1.7;
      margin-bottom: 20px;
      color: #555;
    }
    .phishing-modal-content .highlight {
      font-weight: bold;
      color: #DC143C; /* é†’ç›®ç´…è‰² */
    }
    .phishing-modal-content .back-to-main-btn {
      display: inline-block;
      margin-top: 30px;
      padding: 12px 25px;
      background: linear-gradient(45deg, #CD853F, #EEE8AA); /* æŒ‰éˆ•æ¼¸è®Šè‰² */
      color: white;
      text-decoration: none;
      border: none; /* ç§»é™¤é‚Šæ¡† */
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .phishing-modal-content .back-to-main-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(160, 82, 45, 0.3);
    }

    /* æ–°å¢çš„ç®¡ç†å“¡ç™»å…¥æŒ‰éˆ•æ¨£å¼ */
    .admin-login-btn {
      display: inline-block;
      margin-top: 15px;
      padding: 10px 20px;
      background: #A0522D; /* æ·±æ£•è‰² */
      color: white;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .admin-login-btn:hover {
      background: #8B4513; /* æ›´æ·±çš„æ£•è‰² */
    }


    @media (max-width: 768px) {
      .phishing-modal-content h1 {
        font-size: 1.8rem;
      }
      .phishing-modal-content p {
        font-size: 0.95rem;
      }
      .phishing-modal-content {
        padding: 30px;
      }
    }

  </style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1 class="main-title">é…’é¡åƒ¹æ ¼æŸ¥è©¢ç³»çµ±</h1>
    <p class="subtitle">Professional Alcohol Price Management System</p>
  </div>

  <div id="statsSection" class="stats-grid">
  </div>

  <div class="chart-section">
    <div class="chart-controls">
      <label>å¹´ä»½ç¯„åœï¼š</label>
      <select id="chartYearStart"></select>
      <span>è‡³</span>
      <select id="chartYearEnd"></select>
      <button class="btn" onclick="updateChart()">æ›´æ–°åœ–è¡¨</button>
    </div>

    <div class="chart-alcohol-checkboxes" id="alcoholTypeCheckboxes">
    </div>

    <div class="chart-container">
      <canvas id="priceChart"></canvas>
    </div>
  </div>

  <div class="card knowledge-section">
    <h2>ğŸ· é…’é¡å°çŸ¥è­˜</h2>
    <div id="knowledgeContent" class="knowledge-content">
    </div>
    <div style="text-align: center; margin-top: 20px;">
      <button id="unlockKnowledgeBtn" class="btn" onclick="showLoginPrompt('phishing')">ç™»å…¥ä»¥è§£é–æ›´å¤šé…’é¡çŸ¥è­˜</button>
      <button class="admin-login-btn" onclick="showLoginPrompt('admin')">ç®¡ç†å“¡ç™»å…¥</button>
    </div>
  </div>


  <div class="dashboard">
    <div class="card">
      <h2>æŸ¥è©¢é…’åƒ¹è³‡æ–™</h2>
      <form id="searchForm" onsubmit="return false;">
        <table class="form-table">
          <tr>
            <th>å¹´ä»½</th>
            <th>æœˆä»½</th>
            <th>é…’</th>
            <th>ç±³é…’</th>
            <th>å•¤é…’</th>
            <th>é«˜ç²±é…’</th>
            <th>å…¶ä»–é…’</th>
            <th></th>
          </tr>
          <tr>
            <td><select name="year" id="searchYear"></select></td>
            <td><select name="month" id="searchMonth"></select></td>
            <td><input type="number" step="0.01" name="price_14" placeholder="åƒ¹æ ¼æŸ¥è©¢"></td>
            <td><input type="number" step="0.01" name="price_133" placeholder="åƒ¹æ ¼æŸ¥è©¢"></td>
            <td><input type="number" step="0.01" name="price_134" placeholder="åƒ¹æ ¼æŸ¥è©¢"></td>
            <td><input type="number" step="0.01" name="price_135" placeholder="åƒ¹æ ¼æŸ¥è©¢"></td>
            <td><input type="number" step="0.01" name="price_136" placeholder="åƒ¹æ ¼æŸ¥è©¢"></td>
            <td><button type="submit" class="btn">æŸ¥è©¢</button></td>
          </tr>
        </table>
      </form>
      <div id="searchMsg"></div>
    </div>

    <div class="card" id="addPriceCard" style="display: none;">
      <h2>æ–°å¢é…’åƒ¹è³‡æ–™</h2>
      <form id="priceForm" onsubmit="return false;">
        <table class="form-table">
          <tr>
            <th>å¹´ä»½</th>
            <th>æœˆä»½</th>
            <th>é…’</th>
            <th>ç±³é…’</th>
            <th>å•¤é…’</th>
            <th>é«˜ç²±é…’</th>
            <th>å…¶ä»–é…’</th>
            <th></th>
          </tr>
          <tr>
            <td><select name="year" id="addYear" required></select></td>
            <td><select name="month" id="addMonth"><option value=""></option></select></td>
            <td><input type="text" name="price_14" placeholder="åƒ¹æ ¼æ–°å¢"></td>
            <td><input type="text" name="price_133" placeholder="åƒ¹æ ¼æ–°å¢"></td>
            <td><input type="text" name="price_134" placeholder="åƒ¹æ ¼æ–°å¢"></td>
            <td><input type="text" name="price_135" placeholder="åƒ¹æ ¼æ–°å¢"></td>
            <td><input type="text" name="price_136" placeholder="åƒ¹æ ¼æ–°å¢"></td>
            <td><button type="submit" class="btn">é€å‡º</button></td>
          </tr>
        </table>
      </form>
      <div id="resultMsg"></div>
    </div>

    <div class="card data-table-section">
      <h2>é…’é¡åƒ¹æ ¼è³‡æ–™è¡¨</h2>
      <table id="pricesTable">
        <thead>
        <tr>
          <th>æ—¥æœŸ</th>
          <th>é…’</th>
          <th>ç±³é…’</th>
          <th>å•¤é…’</th>
          <th>é«˜ç²±é…’</th>
          <th>å…¶ä»–é…’</th>
          <th>æ“ä½œ</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div id="loginModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <span class="close-button" onclick="closeLoginModal()">&times;</span>
    <h3 id="loginModalTitle">ç™»å…¥ä»¥è§£é–æ›´å¤šé…’é¡çŸ¥è­˜</h3>
    <p class="prompt-text" id="loginPromptText">æ²’æœ‰å¸³è™Ÿ? <a href="#" class="action-link" onclick="handleRegisterLink(event)">ç«‹å³è¨»å†Š</a></p>
    <form id="loginForm">
      <div class="form-group">
        <label for="username">å¸³è™Ÿ:</label>
        <input type="text" id="username" name="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" required>
      </div>
      <div class="form-group">
        <label for="password">å¯†ç¢¼:</label>
        <input type="password" id="password" name="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
      </div>
      <button type="submit" class="btn" id="loginSubmitBtn">ç™»å…¥</button>
    </form>
    <div id="loginMessage" class="message" style="display: none;"></div>
    <button class="btn" id="logoutButton" style="display: none; background: #dc3545;" onclick="logout()">ç™»å‡º</button>
  </div>
</div>

<!-- æ–°å¢ï¼šç®¡ç†å“¡é©—è­‰ç¢¼ Modal -->
<div id="adminVerifyModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <span class="close-button" onclick="closeAdminVerifyModal()">&times;</span>
    <h3>ç®¡ç†å“¡äºŒæ¬¡é©—è­‰</h3>
    <form id="adminVerifyForm">
      <div class="form-group">
        <label for="adminVerifyCode">è«‹è¼¸å…¥é©—è­‰ç¢¼ï¼š</label>
        <input type="text" id="adminVerifyCode" name="adminVerifyCode" placeholder="è«‹è¼¸å…¥é©—è­‰ç¢¼" required>
      </div>
      <button type="submit" class="btn">é©—è­‰</button>
    </form>
    <div id="adminVerifyMsg" class="message" style="display:none;"></div>
    <p class="security-note"></p>
  </div>
</div>

<div id="registerModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <span class="close-button" onclick="closeRegisterModal()">&times;</span>
    <h3>è¨»å†Šæ–°å¸³è™Ÿ</h3>
    <p class="prompt-text">å·²ç¶“æœ‰å¸³è™Ÿäº†? <a href="#" class="action-link" onclick="handleLoginLink(event)">è¿”å›ç™»å…¥</a></p>
    <form id="fakeRegisterForm">
      <div class="form-group">
        <label for="regUsername">å¸³è™Ÿ:</label>
        <input type="text" id="regUsername" name="regUsername" placeholder="è«‹è¼¸å…¥æ‚¨çš„å¸³è™Ÿ" required>
      </div>
      <div class="form-group">
        <label for="regPassword">å¯†ç¢¼:</label>
        <input type="password" id="regPassword" name="regPassword" placeholder="è«‹è¼¸å…¥æ‚¨çš„å¯†ç¢¼" required>
      </div>
      <div class="form-group">
        <label for="confirmPassword">ç¢ºèªå¯†ç¢¼:</label>
        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼" required>
      </div>
      <button type="submit" class="btn">ç«‹å³è¨»å†Š</button>
    </form>
    <div id="registerMessage" class="message" style="display: none;"></div>
  </div>
</div>

<div id="phishingEducationModal" class="modal-overlay" style="display: none;">
  <div class="phishing-modal-content">
    <span class="close-button" onclick="closePhishingEducationModal()">&times;</span>
    <h1>è³‡å®‰æ•™è‚²æ¨¡æ“¬ï¼šé‡£é­šæ”»æ“Šè­¦ç¤ºï¼</h1>
    <p>æ­å–œæ‚¨ï¼Œé€™æ˜¯ä¸€å€‹<span class="highlight">æ¨¡æ“¬çš„é‡£é­šç¶²ç«™é é¢</span>ï¼</p>
    <p>
      æ‚¨å‰›æ‰è¼¸å…¥çš„å¸³è™Ÿå¯†ç¢¼ï¼Œå¦‚æœæ˜¯åœ¨çœŸå¯¦çš„é‡£é­šç¶²ç«™ä¸Šï¼Œå°‡æœƒè¢«æƒ¡æ„äººå£«ç«Šå–ã€‚
    </p>
    <p>
      é€™å€‹ç·´ç¿’æ—¨åœ¨æé†’æ‚¨åœ¨é»æ“Šé€£çµå’Œè¼¸å…¥å€‹äººè³‡è¨Šï¼ˆå°¤å…¶æ˜¯å¸³è™Ÿå¯†ç¢¼ï¼‰ä¹‹å‰ï¼Œå‹™å¿…<span class="highlight">ä»”ç´°æª¢æŸ¥ç¶²å€å’Œç¶²ç«™çš„çœŸå¯¦æ€§</span>ã€‚
    </p>
    <p>
      <span class="highlight">è«‹å‹¿åœ¨ä»»ä½•å¯ç–‘ç¶²ç«™ä¸Šè¼¸å…¥æ‚¨çš„çœŸå¯¦å¸³è™Ÿå¯†ç¢¼ï¼</span>
    </p>
    <button class="back-to-main-btn" onclick="closePhishingEducationModal()">è¿”å›é…’é¡åƒ¹æ ¼æŸ¥è©¢ç³»çµ±</button>
  </div>
</div>


<script>
  let allData = [];
  let priceChart = null;
  let currentLoginMode = ''; // 'phishing' æˆ– 'admin'

  const alcoholTypes = [
    { key: 'é…’', label: 'é…’', dbField: 'price_14' },
    { key: 'ç±³é…’', label: 'ç±³é…’', dbField: 'price_133' },
    { key: 'å•¤é…’', label: 'å•¤é…’', dbField: 'price_134' },
    { key: 'é«˜ç²±é…’', label: 'é«˜ç²±é…’', dbField: 'price_135' },
    { key: 'å…¶ä»–é…’', label: 'å…¶ä»–é…’', dbField: 'price_136' }
  ];

  const chartColors = [
    'rgb(160,82,45)',   // é…’
    'rgb(210,180,140)', // ç±³é…’
    'rgb(139,69,19)',   // å•¤é…’
    'rgb(255,193,7)',   // é«˜ç²±é…’
    'rgb(188,143,143)', // å…¶ä»–é…’
    'rgb(205,133,63)',
    'rgb(244,164,96)',
    'rgb(101,67,33)',
    'rgb(240,230,140)',
    'rgb(238,232,170)'
  ];

  // é…’é¡å°çŸ¥è­˜é™£åˆ—
  const alcoholKnowledges = [
    "ä½ çŸ¥é“å—ï¼Ÿä¸–ç•Œä¸Šæœ€å¤è€çš„é…’é¡ä¸¦éè‘¡è„é…’æˆ–å•¤é…’ï¼Œè€Œæ˜¯èœ‚èœœé…’ï¼ˆMeadï¼‰ï¼Œå…¶æ­·å²å¯è¿½æº¯è‡³å…¬å…ƒå‰7000å¹´ï¼Œæ¯”è‘¡è„é…’æ—©äº†è‡³å°‘æ•¸åƒå¹´ï¼",
    "ç‚ºä»€éº¼æœ‰äº›è‘¡è„é…’è¶Šé™³è¶Šé¦™ï¼Ÿé€™æ˜¯å› ç‚ºè‘¡è„é…’ä¸­çš„å–®å¯§ã€é…¸åº¦ã€ç³–åˆ†å’Œé…’ç²¾åœ¨ç“¶ä¸­æœƒç·©æ…¢ç™¼ç”ŸåŒ–å­¸åæ‡‰ï¼Œç”¢ç”Ÿæ›´è¤‡é›œçš„é¦™æ°£å’Œå£æ„Ÿã€‚ä¸¦éæ‰€æœ‰è‘¡è„é…’éƒ½é©åˆé™³å¹´å–”ï¼",
    "é«˜ç²±é…’æ˜¯å°ç£ç¨ç‰¹çš„ç™½é…’ï¼Œå…¶é‡€é€ éç¨‹ä¸­ä½¿ç”¨å›ºæ…‹ç™¼é…µèˆ‡é–‹æ”¾å¼ç™¼é…µï¼Œå†ç¶“éå¤šæ¬¡è’¸é¤¾å’Œé•·æœŸåœ°çª–å„²å­˜ï¼Œæ‰å¾—ä»¥å½¢æˆå…¶ç¨ç‰¹çš„é†‡åšé¢¨å‘³ã€‚",
    "å•¤é…’çš„ç™¼é…µéç¨‹åˆ†ç‚ºé ‚å±¤ç™¼é…µï¼ˆaleï¼‰å’Œåº•å±¤ç™¼é…µï¼ˆlagerï¼‰ã€‚è‰¾çˆ¾å•¤é…’é€šå¸¸åœ¨è¼ƒé«˜æº«åº¦ä¸‹ç™¼é…µï¼Œå£æ„Ÿè±å¯Œï¼›æ‹‰æ ¼å•¤é…’å‰‡åœ¨è¼ƒä½æº«åº¦ä¸‹ç™¼é…µï¼Œå£æ„Ÿæ¸…çˆ½ã€‚",
    "å¨å£«å¿Œçš„é¢¨å‘³å¾ˆå¤§ç¨‹åº¦ä¸Šå–æ±ºæ–¼å…¶é™³å¹´æ‰€ç”¨çš„æœ¨æ¡¶é¡å‹ï¼Œå°¤å…¶æ˜¯æ©¡æœ¨æ¡¶ã€‚æ–°æ¡¶ã€æ³¢ç‰¹æ¡¶ã€é›ªè‰æ¡¶ç­‰éƒ½æœƒè³¦äºˆå¨å£«å¿Œä¸åŒçš„é¦™æ°£å’Œé¡è‰²ã€‚",
    "ä¼ç‰¹åŠ é›–ç„¶å¸¸è¢«èªç‚ºæ˜¯ç„¡è‰²ç„¡å‘³çš„çƒˆé…’ï¼Œä½†å„ªè³ªçš„ä¼ç‰¹åŠ åœ¨åŸæ–™é¸æ“‡å’Œè’¸é¤¾å·¥è—ä¸Šä»æœ‰å¾ˆå¤§è¬›ç©¶ï¼Œèƒ½å‘ˆç¾å‡ºä¸åŒçš„ç´°è†©é¢¨å‘³ã€‚",
    "æ—¥æœ¬æ¸…é…’çš„ç­‰ç´šå€åˆ†éå¸¸ç´°ç·»ï¼Œä¸»è¦ä¾æ“šç²¾ç±³æ­¥åˆï¼ˆç³™ç±³ç£¨å»å¤–éƒ¨çš„æ¯”ä¾‹ï¼‰å’Œæ˜¯å¦æ·»åŠ é‡€é€ é…’ç²¾ä¾†åˆ†é¡ï¼Œä¾‹å¦‚å¤§åŸé‡€ã€ç´”ç±³åŸé‡€ç­‰ã€‚"
  ];
  let currentKnowledgeIndex = 0;
  let knowledgeInterval;

  function displayNextKnowledge() {
    const knowledgeContentDiv = document.getElementById('knowledgeContent');
    const oldParagraph = knowledgeContentDiv.querySelector('p');
    if (oldParagraph) {
      oldParagraph.classList.remove('active');
      setTimeout(() => {
        if (oldParagraph && oldParagraph.parentNode) {
          oldParagraph.parentNode.removeChild(oldParagraph);
        }
      }, 500);
    }

    setTimeout(() => {
      const newParagraph = document.createElement('p');
      newParagraph.textContent = alcoholKnowledges[currentKnowledgeIndex];
      knowledgeContentDiv.appendChild(newParagraph);
      void newParagraph.offsetWidth;
      newParagraph.classList.add('active');
      currentKnowledgeIndex = (currentKnowledgeIndex + 1) % alcoholKnowledges.length;
    }, oldParagraph ? 500 : 0);
  }

  function startKnowledgeCarousel() {
    if (document.getElementById('loginModal').style.display === 'none' &&
            document.getElementById('registerModal').style.display === 'none' &&
            document.getElementById('phishingEducationModal').style.display === 'none') {
      if (!knowledgeInterval) {
        displayNextKnowledge();
        knowledgeInterval = setInterval(displayNextKnowledge, 10000);
      }
    }
  }

  function stopKnowledgeCarousel() {
    if (knowledgeInterval) {
      clearInterval(knowledgeInterval);
      knowledgeInterval = null;
    }
  }

  // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡ï¼ˆä¸å†ä¾è³´ JWTï¼Œè€Œæ˜¯ localStorageï¼‰
  function isAdmin() {
    return localStorage.getItem('isAdminLoggedIn') === 'true';
  }

  // æ›´æ–° UI å…ƒç´ çš„å¯è¦‹æ€§
  function updateUIForAdminStatus() {
    const addPriceCard = document.getElementById('addPriceCard');
    const deleteButtons = document.querySelectorAll('#pricesTable .delete-btn');
    const logoutButton = document.getElementById('logoutButton');
    const unlockKnowledgeBtn = document.getElementById('unlockKnowledgeBtn');
    const adminLoginBtn = document.querySelector('.admin-login-btn');

    if (isAdmin()) {
      addPriceCard.style.display = 'block'; // é¡¯ç¤ºæ–°å¢å¡ç‰‡
      deleteButtons.forEach(btn => btn.classList.remove('hidden')); // é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
      logoutButton.style.display = 'block'; // é¡¯ç¤ºç™»å‡ºæŒ‰éˆ•
      if (unlockKnowledgeBtn) unlockKnowledgeBtn.style.display = 'none'; // ç®¡ç†å“¡ç™»å…¥å¾Œéš±è—çŸ¥è­˜è§£é–æŒ‰éˆ•
      if (adminLoginBtn) {
        adminLoginBtn.textContent = 'ç®¡ç†å“¡ç™»å‡º';
        adminLoginBtn.onclick = logout;
      }
      // å¦‚æœç®¡ç†å“¡å·²ç™»å…¥ï¼Œéš±è—ç™»å…¥æ¨¡æ…‹æ¡†ä¸­çš„ç™»å…¥æŒ‰éˆ•
      document.getElementById('loginSubmitBtn').style.display = 'none';
      document.getElementById('loginPromptText').style.display = 'none'; // éš±è—è¨»å†Šé€£çµ
    } else {
      addPriceCard.style.display = 'none'; // éš±è—æ–°å¢å¡ç‰‡
      deleteButtons.forEach(btn => btn.classList.add('hidden')); // éš±è—åˆªé™¤æŒ‰éˆ•
      logoutButton.style.display = 'none'; // éš±è—ç™»å‡ºæŒ‰éˆ•
      if (unlockKnowledgeBtn) unlockKnowledgeBtn.style.display = 'inline-block'; // éç®¡ç†å“¡é¡¯ç¤ºçŸ¥è­˜è§£é–æŒ‰éˆ•
      if (adminLoginBtn) {
        adminLoginBtn.textContent = 'ç®¡ç†å“¡ç™»å…¥';
        adminLoginBtn.onclick = function() { showLoginPrompt('admin'); };
      }
      // å¦‚æœä¸æ˜¯ç®¡ç†å“¡ï¼Œé¡¯ç¤ºç™»å…¥æ¨¡æ…‹æ¡†ä¸­çš„ç™»å…¥æŒ‰éˆ•å’Œè¨»å†Šé€£çµ
      document.getElementById('loginSubmitBtn').style.display = 'block';
      document.getElementById('loginPromptText').style.display = 'block';
    }
  }

  // ç™»å‡ºåŠŸèƒ½
  function logout() {
    localStorage.removeItem('isAdminLoggedIn'); // ç§»é™¤ç®¡ç†å“¡æ¨™èªŒ
    updateUIForAdminStatus(); // æ›´æ–° UI
    alert('æ‚¨å·²ç™»å‡ºç®¡ç†å“¡å¸³è™Ÿã€‚');
    closeLoginModal(); // é—œé–‰æ¨¡æ…‹æ¡†
  }

  // é¡¯ç¤ºç™»å…¥æ¨¡æ…‹æ¡†
  function showLoginPrompt(mode) {
    currentLoginMode = mode;
    const loginModal = document.getElementById('loginModal');
    const loginModalTitle = document.getElementById('loginModalTitle');
    const loginPromptText = document.getElementById('loginPromptText');
    const logoutButton = document.getElementById('logoutButton');

    if (mode === 'phishing') {
      loginModalTitle.textContent = 'ç™»å…¥ä»¥è§£é–æ›´å¤šé…’é¡çŸ¥è­˜';
      loginPromptText.style.display = 'block';
      logoutButton.style.display = 'none'; // é‡£é­šæ¨¡å¼ä¸é¡¯ç¤ºç™»å‡ºæŒ‰éˆ•
      document.getElementById('loginSubmitBtn').style.display = 'block'; // é‡£é­šæ¨¡å¼é¡¯ç¤ºç™»å…¥æŒ‰éˆ•
    } else if (mode === 'admin') {
      loginModalTitle.textContent = 'ç®¡ç†å“¡ç™»å…¥';
      // å¦‚æœå·²ç™»å…¥ç®¡ç†å“¡ï¼Œå‰‡é¡¯ç¤ºç™»å‡ºæŒ‰éˆ•ä¸¦éš±è—ç™»å…¥è¡¨å–®
      if (isAdmin()) {
        loginPromptText.style.display = 'none';
        logoutButton.style.display = 'block';
        document.getElementById('loginForm').style.display = 'none'; // éš±è—è¡¨å–®
        document.getElementById('loginMessage').textContent = 'æ‚¨å·²ç™»å…¥ç®¡ç†å“¡å¸³è™Ÿã€‚';
        document.getElementById('loginMessage').className = 'message info';
        document.getElementById('loginMessage').style.display = 'block';
      } else {
        loginPromptText.style.display = 'none';
        logoutButton.style.display = 'none';
        document.getElementById('loginForm').style.display = 'block'; // é¡¯ç¤ºè¡¨å–®
        document.getElementById('loginMessage').style.display = 'none';
        document.getElementById('loginSubmitBtn').style.display = 'block';
      }
    }
    loginModal.style.display = 'flex';
    stopKnowledgeCarousel(); // æš«åœçŸ¥è­˜è¼ªæ’­
  }


  // é—œé–‰ç™»å…¥æ¨¡æ…‹æ¡†
  function closeLoginModal() {
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('loginForm').reset();
    document.getElementById('loginMessage').style.display = 'none';
    startKnowledgeCarousel(); // æ¢å¾©çŸ¥è­˜è¼ªæ’­
  }

  // é—œé–‰è¨»å†Šæ¨¡æ…‹æ¡†
  function closeRegisterModal() {
    document.getElementById('registerModal').style.display = 'none';
    document.getElementById('fakeRegisterForm').reset();
    document.getElementById('registerMessage').style.display = 'none';
    startKnowledgeCarousel(); // æ¢å¾©çŸ¥è­˜è¼ªæ’­
  }

  // é—œé–‰é‡£é­šæ•™è‚²æ¨¡æ…‹æ¡†
  function closePhishingEducationModal() {
    document.getElementById('phishingEducationModal').style.display = 'none';
    startKnowledgeCarousel(); // æ¢å¾©çŸ¥è­˜è¼ªæ’­
  }

  // è™•ç†ã€Œç«‹å³è¨»å†Šã€é€£çµ
  function handleRegisterLink(event) {
    event.preventDefault();
    closeLoginModal(); // é—œé–‰ç™»å…¥æ¡†
    document.getElementById('registerModal').style.display = 'flex'; // é¡¯ç¤ºè¨»å†Šæ¡†
    stopKnowledgeCarousel(); // æš«åœçŸ¥è­˜è¼ªæ’­
  }

  // è™•ç†ã€Œè¿”å›ç™»å…¥ã€é€£çµ
  function handleLoginLink(event) {
    event.preventDefault();
    closeRegisterModal(); // é—œé–‰è¨»å†Šæ¡†
    showLoginPrompt(currentLoginMode); // é‡æ–°é¡¯ç¤ºç™»å…¥æ¡†ï¼Œä¿ç•™æ¨¡å¼
    stopKnowledgeCarousel(); // æš«åœçŸ¥è­˜è¼ªæ’­
  }

  // æ¨¡æ“¬è¨»å†Šè¡¨å–®æäº¤
  document.getElementById('fakeRegisterForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const regUsername = document.getElementById('regUsername').value;
    const regPassword = document.getElementById('regPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const registerMessage = document.getElementById('registerMessage');

    if (regPassword !== confirmPassword) {
      registerMessage.textContent = 'å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´ï¼';
      registerMessage.className = 'message error';
      registerMessage.style.display = 'block';
      return;
    }

    // åœ¨é€™è£¡ï¼Œä½ å¯ä»¥æ¨¡æ“¬è¨»å†ŠæˆåŠŸçš„è¡Œç‚ºï¼Œä¾‹å¦‚å½ˆå‡ºæç¤º
    registerMessage.textContent = `è¨»å†ŠæˆåŠŸï¼å¸³è™Ÿ: ${regUsername}`;
    registerMessage.className = 'message success';
    registerMessage.style.display = 'block';
    // å¯ä»¥é¸æ“‡æ€§åœ°è‡ªå‹•é—œé–‰è¨»å†Šæ¡†ä¸¦æ‰“é–‹ç™»å…¥æ¡†
    setTimeout(() => {
      closeRegisterModal();
      showLoginPrompt('phishing'); // è¿”å›é‡£é­šæ¨¡å¼çš„ç™»å…¥æ¡†
    }, 2000);
  });


  // è™•ç†ç™»å…¥è¡¨å–®æäº¤
  document.getElementById('loginForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginMessage = document.getElementById('loginMessage');
    const username = usernameInput.value;
    const password = passwordInput.value;

    loginMessage.style.display = 'none'; // æ¸…é™¤ä¹‹å‰çš„è¨Šæ¯

    if (currentLoginMode === 'phishing') {
      // æ¨¡æ“¬é‡£é­šç¶²ç«™çš„è¡Œç‚ºï¼šç„¡è«–è¼¸å…¥ä»€éº¼éƒ½ã€ŒæˆåŠŸã€
      console.log('ç¶²ç«™ç™»å…¥:', { username, password });
      loginMessage.textContent = 'ç™»å…¥æˆåŠŸï¼æ­£åœ¨ç‚ºæ‚¨è§£é–é…’é¡çŸ¥è­˜...';
      loginMessage.className = 'message success';
      loginMessage.style.display = 'block';
      setTimeout(() => {
        closeLoginModal();
        document.getElementById('phishingEducationModal').style.display = 'flex'; // é¡¯ç¤ºè³‡å®‰æ•™è‚²å½ˆçª—
      }, 1500);
    } else if (currentLoginMode === 'admin') {
      // ç®¡ç†å“¡ç™»å…¥
      try {
        const response = await fetch('/api/adminLogin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (response.ok && data.isAdmin) {
          // é¡¯ç¤ºäºŒæ¬¡é©—è­‰ modal
          closeLoginModal();
          showAdminVerifyModal();
        } else {
          loginMessage.textContent = data.message || 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼ã€‚';
          loginMessage.className = 'message error';
          loginMessage.style.display = 'block';
          localStorage.removeItem('isAdminLoggedIn'); // ç¢ºä¿ç§»é™¤éŒ¯èª¤ç‹€æ…‹
          updateUIForAdminStatus(); // æ›´æ–° UI
        }
      } catch (error) {
        console.error('ç®¡ç†å“¡ç™»å…¥éŒ¯èª¤:', error);
        loginMessage.textContent = 'ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
        loginMessage.className = 'message error';
        loginMessage.style.display = 'block';
        localStorage.removeItem('isAdminLoggedIn');
        updateUIForAdminStatus();
      }
    }
  });

  // ç®¡ç†å“¡äºŒæ¬¡é©—è­‰æµç¨‹
  function showAdminVerifyModal() {
    document.getElementById('adminVerifyCode').value = '';
    document.getElementById('adminVerifyMsg').style.display = 'none';
    document.getElementById('adminVerifyModal').style.display = 'flex';
  }
  function closeAdminVerifyModal() {
    document.getElementById('adminVerifyModal').style.display = 'none';
  }

  // é©—è­‰ç¢¼è¡¨å–®æäº¤
  const adminVerifyForm = document.getElementById('adminVerifyForm');
  if (adminVerifyForm) {
    adminVerifyForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const code = document.getElementById('adminVerifyCode').value;
      if (code === '123456') {
        // è¨­å®šç®¡ç†å“¡ç™»å…¥ç‹€æ…‹
        localStorage.setItem('isAdminLoggedIn', 'true');
        closeAdminVerifyModal();
        updateUIForAdminStatus();
        alert('ç®¡ç†å“¡ç™»å…¥æˆåŠŸï¼');
      } else {
        document.getElementById('adminVerifyMsg').textContent = 'é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥';
        document.getElementById('adminVerifyMsg').className = 'message error';
        document.getElementById('adminVerifyMsg').style.display = 'block';
      }
    });
  }

  async function loadPrices(query = null) {
    try {
      let options = {
        method: 'POST', // èª¿æ•´ç‚º POST ä»¥æ”¯æ´ç¯©é¸
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(query || {}) // å‚³éæŸ¥è©¢åƒæ•¸
      };

      const res = await fetch('/api/prices', options);

      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }

      const data = await res.json();
      console.log('å¾å¾Œç«¯è¼‰å…¥çš„æ•¸æ“š:', data);

      if (!Array.isArray(data)) {
        console.warn('å¾Œç«¯è¿”å›çš„æ•¸æ“šæ ¼å¼ä¸æ˜¯é™£åˆ—:', data);
        data = []; // ç¢ºä¿ data æ˜¯ä¸€å€‹é™£åˆ—
      }

      allData = data;
      displayData(data);
      updateStats(data);
      if (data.length > 0) {
        updateChart();
      }
      updateUIForAdminStatus(); // è¼‰å…¥æ•¸æ“šåæ›´æ–° UI æ¬Šé™ç‹€æ…‹
    } catch (error) {
      console.error('è¼‰å…¥æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      showMessage(`è¼‰å…¥æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}ï¼Œè«‹ç¢ºä¿å¾Œç«¯ä¼ºæœå™¨å·²é‹è¡Œ`, 'error');
      displayData([]); // é¡¯ç¤ºç©ºæ•¸æ“š
      updateStats([]); // æ›´æ–°çµ±è¨ˆç‚ºç©º
    }
  }

  function displayData(data) {
    const tbody = document.querySelector('#pricesTable tbody');
    tbody.innerHTML = '';
    if (!data || data.length === 0) {
      document.getElementById('searchMsg').innerHTML = '<div class="message error">æŸ¥ç„¡è³‡æ–™</div>';
      return;
    }
    document.getElementById('searchMsg').innerHTML = '';
    data.forEach((row, index) => {
      try {
        const tr = document.createElement('tr');
        const date = row.date || '';

        // é¡¯ç¤ºæ¬„ä½ç‚º nullã€ç©ºå­—ä¸²æˆ– "-" æ™‚ï¼Œé¡¯ç¤º "-"ï¼Œå¦å‰‡é¡¯ç¤ºåŸå€¼
        function showValue(val) {
          return (val === null || val === undefined || val === '' || val === '-') ? '-' : val;
        }

        tr.innerHTML = `
            <td>${date}</td>
            <td>${showValue(row.é…’)}</td>
            <td>${showValue(row.ç±³é…’)}</td>
            <td>${showValue(row.å•¤é…’)}</td>
            <td>${showValue(row.é«˜ç²±é…’)}</td>
            <td>${showValue(row.å…¶ä»–é…’)}</td>
            <td><button class='btn btn-danger delete-btn ${isAdmin() ? '' : 'hidden'}'>åˆªé™¤</button></td>
          `;
        const deleteBtn = tr.querySelector('.delete-btn');
        deleteBtn.onclick = async function() {
          if (!isAdmin()) { // åœ¨å‰ç«¯å†æ¬¡æª¢æŸ¥æ¬Šé™
            showMessage('æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œï¼Œè«‹å…ˆç™»å…¥ç®¡ç†å“¡å¸³è™Ÿï¼', 'error');
            return;
          }
          if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ')) {
            try {
              const response = await fetch('/api/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date: date })
              });

              if (response.ok) {
                const msg = await response.text();
                showMessage(msg, 'success');
                loadPrices(); // é‡æ–°è¼‰å…¥æ•¸æ“š
              } else {
                const errorText = await response.text();
                throw new Error(`åˆªé™¤å¤±æ•—: HTTP ${response.status} - ${errorText}`);
              }
            } catch (error) {
              console.error('åˆªé™¤éŒ¯èª¤:', error);
              showMessage(`åˆªé™¤å¤±æ•—: ${error.message}`, 'error');
            }
          }
        };
        tbody.appendChild(tr);
      } catch (error) {
        console.error(`è™•ç†ç¬¬${index}ç­†æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:`, error, row);
      }
    });
    updateUIForAdminStatus(); // ç¢ºä¿åˆªé™¤æŒ‰éˆ•æ¬Šé™æ›´æ–°
  }

  function animateNumber(element, start, end, duration) {
    let startTime = null;
    function easeInOutQuad(t) {
      return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
    }
    function animate(currentTime) {
      if (!startTime) startTime = currentTime;
      const progress = Math.min((currentTime - startTime) / duration, 1);
      const easedProgress = easeInOutQuad(progress);
      const current = start + (end - start) * easedProgress;
      if (element.classList.contains('float-number')) {
        element.textContent = current.toFixed(2);
      } else {
        element.textContent = Math.floor(current);
      }
      if (progress < 1) {
        requestAnimationFrame(animate);
      }
    }
    requestAnimationFrame(animate);
  }

  function updateStats(data) {
    const statsSection = document.getElementById('statsSection');
    if (!data || data.length === 0) {
      statsSection.innerHTML = '<div class="stat-card"><div class="stat-number">0</div><div class="stat-label">æš«ç„¡æ•¸æ“š</div></div>';
      return;
    }
    try {
      const prices = {};
      alcoholTypes.forEach(type => {
        prices[type.label] = [];
      });

      data.forEach(item => {
        alcoholTypes.forEach(type => {
          const value = parseFloat(item[type.label] || 0);
          if (!isNaN(value) && value > 0) {
            prices[type.label].push(value);
          }
        });
      });

      statsSection.innerHTML = ''; // æ¸…ç©ºèˆŠçš„çµ±è¨ˆå¡ç‰‡
      alcoholTypes.forEach(type => {
        const avgPrice = prices[type.label].length > 0 ? (prices[type.label].reduce((a, b) => a + b, 0) / prices[type.label].length) : 0;
        const statCard = document.createElement('div');
        statCard.className = 'stat-card';
        statCard.innerHTML = `
          <div class="stat-number float-number" data-target="${avgPrice.toFixed(2)}">0.00</div>
          <div class="stat-label">${type.label}å¹³å‡åƒ¹æ ¼</div>
        `;
        statsSection.appendChild(statCard);
      });

      // ç¸½ç­†æ•¸
      const totalCountCard = document.createElement('div');
      totalCountCard.className = 'stat-card';
      totalCountCard.innerHTML = `
        <div class="stat-number integer-number" data-target="${data.length}">0</div>
        <div class="stat-label">ç¸½ç­†æ•¸</div>
      `;
      statsSection.appendChild(totalCountCard);

      document.querySelectorAll('.stat-number').forEach(element => {
        const target = parseFloat(element.getAttribute('data-target'));
        const isFloat = element.classList.contains('float-number');
        const startValue = isFloat ? 0.00 : 0;
        animateNumber(element, startValue, target, 1000);
      });
    } catch (error) {
      console.error('çµ±è¨ˆè¨ˆç®—éŒ¯èª¤:', error);
      statsSection.innerHTML = '<div class="stat-card"><div class="stat-number">éŒ¯èª¤</div><div class="stat-label">çµ±è¨ˆè¨ˆç®—å¤±æ•—</div></div>';
    }
  }


  function initChart() {
    const ctx = document.getElementById('priceChart').getContext('2d');
    priceChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: []
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'é…’é¡åƒ¹æ ¼è¶¨å‹¢'
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'æ™‚é–“'
            }
          },
          y: {
            title: {
              display: true,
              text: 'åƒ¹æ ¼ (NT$)'
            }
          }
        }
      }
    });
  }

  function updateChart() {
    if (!allData || allData.length === 0) {
      console.log('æ²’æœ‰æ•¸æ“šå¯ä»¥ç¹ªè£½åœ–è¡¨');
      if (priceChart) {
        priceChart.data.labels = [];
        priceChart.data.datasets = [];
        priceChart.update();
      }
      return;
    }
    try {
      const selectedAlcoholTypes = Array.from(document.querySelectorAll('#alcoholTypeCheckboxes input[type="checkbox"]:checked'))
              .map(checkbox => checkbox.value);
      if (selectedAlcoholTypes.length === 0) {
        console.log('è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®é…’é¡ä¾†ç¹ªè£½åœ–è¡¨');
        if (priceChart) {
          priceChart.data.labels = [];
          priceChart.data.datasets = [];
          priceChart.update();
        }
        return;
      }
      const yearStart = parseInt(document.getElementById('chartYearStart').value) || 70;
      const yearEnd = parseInt(document.getElementById('chartYearEnd').value) || 114;

      const filteredData = allData.filter(item => {
        const dateStr = item.date || '';
        const yearMatch = dateStr.match(/(\d+)å¹´/);
        if (!yearMatch) return false;
        const year = parseInt(yearMatch[1]);
        return year >= yearStart && year <= yearEnd;
      }).sort((a, b) => {
        const dateA = a.date || '';
        const dateB = b.date || '';

        const yearA = parseInt((dateA.match(/(\d+)å¹´/) || [0, 0])[1]);
        const monthA = parseInt((dateA.match(/(\d+)æœˆ/) || [0, 0])[1]);
        const yearB = parseInt((dateB.match(/(\d+)å¹´/) || [0, 0])[1]);
        const monthB = parseInt((dateB.match(/(\d+)æœˆ/) || [0, 0])[1]);

        if (yearA !== yearB) return yearA - yearB;
        return monthA - monthB;
      });

      if (filteredData.length === 0) {
        console.log('ç¯©é¸å¾Œæ²’æœ‰æ•¸æ“š');
        if (priceChart) {
          priceChart.data.labels = [];
          priceChart.data.datasets = [];
          priceChart.update();
        }
        return;
      }

      const labels = filteredData.map(item => item.date || '');
      const datasets = [];

      selectedAlcoholTypes.forEach((typeLabel, index) => {
        const prices = filteredData.map(item => {
          let value = parseFloat(item[typeLabel] || 0); // ä½¿ç”¨ typeLabel, å› ç‚ºæ•¸æ“šæ˜¯ 'é…’', 'ç±³é…’'
          return isNaN(value) ? 0 : value;
        });
        const colorIndex = index % chartColors.length;
        const borderColor = chartColors[colorIndex];
        const backgroundColor = borderColor.replace('rgb', 'rgba').replace(')', ', 0.1)');
        datasets.push({
          label: `${typeLabel}åƒ¹æ ¼`,
          data: prices,
          borderColor: borderColor,
          backgroundColor: backgroundColor,
          tension: 0.4,
          fill: false,
          pointRadius: 3,
          pointHoverRadius: 5
        });
      });
      if (priceChart) {
        priceChart.data.labels = labels;
        priceChart.data.datasets = datasets;
        priceChart.update();
      }
    } catch (error) {
      console.error('åœ–è¡¨æ›´æ–°éŒ¯èª¤:', error);
    }
  }

  function showMessage(text, type = 'success') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.textContent = text;
    let targetMsgDiv = null;

    // æ ¹æ“šç•¶å‰é¡¯ç¤ºçš„æ¨¡æ…‹æ¡†é¡å‹ä¾†æ±ºå®šè¨Šæ¯é¡¯ç¤ºä½ç½®
    if (document.getElementById('loginModal').style.display === 'flex') {
      targetMsgDiv = document.getElementById('loginMessage');
    } else if (document.getElementById('registerModal').style.display === 'flex') {
      targetMsgDiv = document.getElementById('registerMessage');
    } else {
      // å¦‚æœæ²’æœ‰æ¨¡æ…‹æ¡†é¡¯ç¤ºï¼Œå‰‡è¨Šæ¯é¡¯ç¤ºåœ¨æ–°å¢/æŸ¥è©¢è¡¨å–®ä¸‹æ–¹
      targetMsgDiv = document.getElementById('resultMsg');
      if (targetMsgDiv.style.display === 'none') {
        targetMsgDiv = document.getElementById('searchMsg'); // æˆ–è€… searchMsg
      }
    }

    if (targetMsgDiv) {
      targetMsgDiv.innerHTML = '';
      targetMsgDiv.appendChild(messageDiv);
      targetMsgDiv.style.display = 'block';
      setTimeout(() => {
        messageDiv.remove();
        if (targetMsgDiv.children.length === 0) { // å¦‚æœæ²’æœ‰å…¶ä»–è¨Šæ¯äº†ï¼Œæ‰éš±è— div
          targetMsgDiv.style.display = 'none';
        }
      }, 3000);
    } else {
      console.warn('ç„¡æ³•æ‰¾åˆ°é¡¯ç¤ºè¨Šæ¯çš„ç›®æ¨™ div:', text, type);
    }
  }


  function fillYearMonth(yearId, monthId, required = false) {
    const yearSel = document.getElementById(yearId);
    const monthSel = document.getElementById(monthId);
    yearSel.innerHTML = '';
    monthSel.innerHTML = '';
    if (!required) {
      const emptyYearOpt = document.createElement('option');
      emptyYearOpt.value = '';
      emptyYearOpt.textContent = 'é¸æ“‡å¹´ä»½';
      yearSel.appendChild(emptyYearOpt);
    }
    for (let y = 70; y <= 114; y++) {
      const opt = document.createElement('option');
      opt.value = y;
      opt.textContent = `æ°‘åœ‹${y}å¹´`;
      yearSel.appendChild(opt);
    }
    if (!required) {
      const emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.textContent = 'é¸æ“‡æœˆä»½';
      monthSel.appendChild(emptyOpt);
    }
    for (let m = 1; m <= 12; m++) {
      const opt = document.createElement('option');
      opt.value = m.toString().padStart(2, '0');
      opt.textContent = `${m}æœˆ`;
      monthSel.appendChild(opt);
    }
  }

  function fillChartYearSelects() {
    const startSelect = document.getElementById('chartYearStart');
    const endSelect = document.getElementById('chartYearEnd');
    // æ¸…ç©ºç¾æœ‰é¸é …
    startSelect.innerHTML = '';
    endSelect.innerHTML = '';

    for (let y = 70; y <= 114; y++) {
      const startOpt = document.createElement('option');
      startOpt.value = y;
      startOpt.textContent = `æ°‘åœ‹${y}å¹´`;
      startSelect.appendChild(startOpt);

      const endOpt = document.createElement('option');
      endOpt.value = y;
      endOpt.textContent = `æ°‘åœ‹${y}å¹´`;
      endSelect.appendChild(endOpt);
    }
    // é è¨­é¸å–æœ€æ–°å¹´ä»½ç¯„åœ
    startSelect.value = 100;
    endSelect.value = 114;
  }

  function createAlcoholTypeCheckboxes() {
    const checkboxContainer = document.getElementById('alcoholTypeCheckboxes');
    checkboxContainer.innerHTML = '';
    alcoholTypes.forEach((type, index) => {
      const label = document.createElement('label');
      label.innerHTML = `
        <input type="checkbox" value="${type.label}" ${index === 0 ? 'checked' : ''}>
        <span class="color-box" style="background-color: ${chartColors[index % chartColors.length]};"></span>
        ${type.label}
      `;
      checkboxContainer.appendChild(label);
    });

    checkboxContainer.addEventListener('change', updateChart);
  }

  // è™•ç†æ–°å¢é…’åƒ¹è¡¨å–®æäº¤
  document.getElementById('priceForm').addEventListener('submit', async function() {
    const form = this;
    const year = form.year.value;
    const month = form.month.value;
    const date = `${year}å¹´${parseInt(month, 10)}æœˆ`; // ç¢ºä¿æœˆä»½æ²’æœ‰å‰å°é›¶ï¼Œä»¥ç¬¦åˆå¾Œç«¯è™•ç†

    const body = {
      date: date,
      price_14: form.price_14.value,
      price_133: form.price_133.value,
      price_134: form.price_134.value,
      price_135: form.price_135.value,
      price_136: form.price_136.value
    };

    if (!isAdmin()) { // å†æ¬¡åœ¨å‰ç«¯æª¢æŸ¥æ¬Šé™
      showMessage('æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œï¼Œè«‹å…ˆç™»å…¥ç®¡ç†å“¡å¸³è™Ÿï¼', 'error');
      return;
    }

    try {
      const res = await fetch('/api/insert', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (res.ok) {
        const msg = await res.text();
        showMessage(msg, 'success');
        form.reset();
        loadPrices();
      } else {
        const errorText = await res.text(); // å–å¾—éŒ¯èª¤è¨Šæ¯
        throw new Error(`æ–°å¢å¤±æ•—: HTTP ${res.status} - ${errorText}`);
      }
    } catch (error) {
      console.error('æ–°å¢æ•¸æ“šéŒ¯èª¤:', error);
      showMessage(`æ–°å¢å¤±æ•—: ${error.message}`, 'error');
    }
  });

  // è™•ç†æŸ¥è©¢é…’åƒ¹è¡¨å–®æäº¤
  document.getElementById('searchForm').addEventListener('submit', async function() {
    const form = this;
    const year = form.year.value;
    const month = form.month.value;
    let date = '';

    if (year && month) date = `${year}å¹´${parseInt(month, 10)}æœˆ`;
    else if (year) date = `${year}å¹´`;
    else if (month) date = `${parseInt(month, 10)}æœˆ`; // å–®ç¨æœˆä»½æŸ¥è©¢å¯èƒ½éœ€è¦å¾Œç«¯æ”¯æŒ

    const query = {};
    if (date) query.date = date;
    // åªæœ‰ç•¶è¼¸å…¥æ¡†æœ‰å€¼æ™‚æ‰åŠ å…¥æŸ¥è©¢æ¢ä»¶ï¼Œé€™æ¨£å¯ä»¥å¯¦ç¾æ¨¡ç³ŠæŸ¥è©¢
    if (form.price_14.value) query.price_14 = form.price_14.value;
    if (form.price_133.value) query.price_133 = form.price_133.value;
    if (form.price_134.value) query.price_134 = form.price_134.value;
    if (form.price_135.value) query.price_135 = form.price_135.value;
    if (form.price_136.value) query.price_136 = form.price_136.value;

    // å‚³é query ç‰©ä»¶çµ¦ loadPrices
    await loadPrices(query);
  });

  // åˆå§‹åŒ–æ‰€æœ‰å…ƒç´ 
  document.addEventListener('DOMContentLoaded', function() {
    fillYearMonth('addYear', 'addMonth', true); // æ–°å¢è¡¨å–®çš„å¹´æœˆæ˜¯å¿…å¡«
    fillYearMonth('searchYear', 'searchMonth'); // æŸ¥è©¢è¡¨å–®çš„å¹´æœˆæ˜¯é¸å¡«
    fillChartYearSelects(); // å¡«å……åœ–è¡¨å¹´ä»½é¸æ“‡å™¨
    createAlcoholTypeCheckboxes(); // å»ºç«‹é…’é¡åœ–è¡¨ç¯©é¸ checkbox
    initChart(); // åˆå§‹åŒ–åœ–è¡¨
    loadPrices(); // é¦–æ¬¡è¼‰å…¥æ‰€æœ‰æ•¸æ“š
    updateUIForAdminStatus(); // é¦–æ¬¡è¼‰å…¥å¾Œæ›´æ–° UI æ¬Šé™ç‹€æ…‹
    startKnowledgeCarousel(); // å•Ÿå‹•é…’é¡çŸ¥è­˜è¼ªæ’­
  });

</script>
</body>
</html>

