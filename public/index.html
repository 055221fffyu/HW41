<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="專業酒類價格查詢系統，提供酒、米酒、啤酒、高粱酒等各類酒品歷史價格趨勢、數據統計及資料管理功能。輕鬆查詢與新增酒價，掌握市場動態。">
  <title>酒類價格查詢系統 | Professional Alcohol Price System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    /* 全局設定 */
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#FAF9D9 0%,#f5ebe0 100%);min-height:100vh;color:#333;}
    .container{max-width:1400px;margin:0 auto;padding:20px;}

    /* 頁面標題區塊 */
    .header{text-align:center;margin-bottom:40px;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-radius:20px;padding:30px;box-shadow:0 15px 30px rgba(0,0,0,.08);}
    .main-title{font-size:2.8rem;font-weight:700;background:linear-gradient(45deg,#A0522D,#FFC125);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;}
    .subtitle{color:#777;font-size:1.2rem;font-weight:300;}

    /* 儀表板網格布局 */
    .dashboard{display:grid;grid-template-columns:1fr;gap:30px;margin-bottom:40px;}

    /* 卡片通用樣式 */
    .card{background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-radius:18px;padding:25px;box-shadow:0 12px 25px rgba(0,0,0,.07);transition:transform .3s ease,box-shadow .3s ease;}
    .card:hover{transform:translateY(-8px);box-shadow:0 20px 40px rgba(0,0,0,.12);}
    .card h2{color:#555;margin-bottom:20px;font-size:1.5rem;display:flex;align-items:center;gap:10px;}
    .card h2::before{content:'';width:4px;height:22px;background:linear-gradient(45deg,#A0522D,#FFC125);border-radius:2px;}

    /* 表單和表格通用樣式 */
    .form-table{width:100%;border-collapse:collapse;margin-bottom:15px;table-layout:fixed;}
    .form-table th,.form-table td{padding:12px 10px;border-bottom:1px solid #eee;text-align:center;}
    .form-table tr th:nth-child(1),.form-table tr td:nth-child(1){width:15%;}
    .form-table tr th:nth-child(2),.form-table tr td:nth-child(2){width:10%;}
    .form-table tr th:nth-child(3),.form-table tr td:nth-child(3),.form-table tr th:nth-child(4),.form-table tr td:nth-child(4),.form-table tr th:nth-child(5),.form-table tr td:nth-child(5),.form-table tr th:nth-child(6),.form-table tr td:nth-child(6),.form-table tr th:nth-child(7),.form-table tr td:nth-child(7){width:12%;}
    .form-table tr th:nth-child(8),.form-table tr td:nth-child(8){width:10%;}
    .form-table th{background:linear-gradient(45deg,#604020,#805030);color:white;font-weight:600;font-size:.95rem;border-radius:8px 8px 0 0;white-space:nowrap;}
    .form-table input,.form-table select{width:100%;padding:10px 8px;border:1px solid #dcdcdc;border-radius:8px;font-size:.9rem;transition:all .3s ease;min-width:0;}
    .form-table input:focus,.form-table select:focus{outline:none;border-color:#A0522D;box-shadow:0 0 0 3px rgba(160,82,45,.15);}

    /* 按鈕樣式 */
    .btn{background:linear-gradient(45deg,#CD853F,#EEE8AA);color:white;border:none;padding:12px 18px;border-radius:8px;font-weight:600;cursor:pointer;transition:all .3s ease;font-size:.95rem;white-space:nowrap;}
    .btn:hover{transform:translateY(-3px);box-shadow:0 12px 25px rgba(160,82,45,.3);}
    .btn-danger{background:linear-gradient(45deg,#e47d00,#ffb366);}
    .btn-danger:hover{box-shadow:0 12px 25px rgba(228,125,0,.3);}

    /* 訊息提示樣式 */
    .message{padding:12px 16px;border-radius:8px;margin:10px 0;font-weight:500;font-size:.9rem;}
    .message.success{background:rgba(144,238,144,.2);color:#2E8B57;border:1px solid rgba(46,139,87,.3);}
    .message.error{background:rgba(255,182,193,.2);color:#DC143C;border:1px solid rgba(220,20,60,.3);}
    .message.info{background:rgba(173,216,230,.2);color:#4682B4;border:1px solid rgba(70,130,180,.3);}


    /* 圖表區塊樣式 */
    .chart-section{grid-column:1/-1;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-radius:18px;padding:30px;box-shadow:0 15px 30px rgba(0,0,0,.07);margin-bottom:30px;}
    .chart-controls{display:flex;gap:15px;margin-bottom:25px;flex-wrap:wrap;align-items:center;}
    .chart-controls select{padding:10px 15px;border:1px solid #dcdcdc;border-radius:8px;font-size:.9rem;}
    .chart-alcohol-checkboxes{display:flex;flex-wrap:wrap;gap:20px;margin-top:20px;align-items:center;}
    .chart-alcohol-checkboxes label{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:1rem;font-weight:500;color:#444;}
    .chart-alcohol-checkboxes input[type="checkbox"]{-webkit-appearance:none;-moz-appearance:none;appearance:none;width:20px;height:20px;border:2px solid #999;border-radius:5px;cursor:pointer;display:inline-block;position:relative;transition:all .2s ease;}
    .chart-alcohol-checkboxes input[type="checkbox"]:checked{border-color:#A0522D;background-color:#A0522D;}
    .chart-alcohol-checkboxes input[type="checkbox"]:checked::before{content:'✓';display:block;color:white;font-size:16px;line-height:16px;text-align:center;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);}
    .chart-alcohol-checkboxes .color-box{width:18px;height:18px;border-radius:4px;display:inline-block;margin-right:6px;border:1px solid rgba(0,0,0,.1);}
    .chart-container{position:relative;height:450px;margin-bottom:20px;}

    /* 資料表格區塊樣式 */
    .data-table-section{grid-column:1/-1;}
    #pricesTable{width:100%;border-collapse:collapse;background:white;border-radius:12px;overflow:hidden;box-shadow:0 10px 25px rgba(0,0,0,.1);}
    #pricesTable th{background:linear-gradient(45deg,#604020,#805030);color:white;padding:16px 12px;font-weight:600;text-align:center;font-size:.95rem;}
    #pricesTable td{padding:14px;text-align:center;border-bottom:1px solid #f0f0f0;font-size:.9rem;}
    #pricesTable tr:hover{background:rgba(128,80,48,.05);}
    /* 刪除按鈕隱藏 */
    #pricesTable td .delete-btn.hidden {
      display: none;
    }


    /* 統計網格樣式 */
    .stats-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:25px;margin-bottom:30px;}
    .stat-card{background:rgba(255,255,255,.95);padding:25px;border-radius:15px;text-align:center;box-shadow:0 10px 25px rgba(0,0,0,.08);transition:transform .3s ease,box-shadow .3s ease;}
    .stat-card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,.15);}
    .stat-number{font-size:2.2rem;font-weight:700;color:#A0522D;margin-bottom:8px;}
    .stat-label{color:#666;font-size:.95rem;}

    /* 響應式設計 */
    @media (max-width:768px){
      .stats-grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;}
      .main-title{font-size:2.2rem;}
      .subtitle{font-size:1rem;}
      .card h2{font-size:1.3rem;}
      .chart-controls{justify-content:center;}
      .form-table th,.form-table td{padding:8px 5px;font-size:.7rem;}
      .form-table input,.form-table select{font-size:.75rem;padding:6px 5px;}
      .btn{padding:8px 10px;font-size:.75rem;}
      .stat-number{font-size:1.8rem;}
      .stat-label{font-size:.85rem;}
      .chart-container{height:350px;}
      /* 明確分隔查詢和新增酒價資料卡片 */
      .dashboard .card:nth-child(1) { /* 第一個 card 是查詢酒價資料 */
        margin-bottom: 30px; /* 在手機視圖下增加底部間距 */
      }
      /* 確保 data-table-section 也有適當間距 */
      .data-table-section {
        margin-top: 30px;
      }
    }

    /* 加載動畫 */
    .loading{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #A0522D;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

    /* 模態框樣式 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 450px;
      position: relative;
      text-align: center;
    }
    .modal-content h3 {
      margin-bottom: 20px;
      color: #333;
    }
    .close-button {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      cursor: pointer;
      color: #888;
    }
    .close-button:hover {
      color: #555;
    }
    .form-group {
      margin-bottom: 15px;
      text-align: left;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    .form-group input:focus {
      outline: none;
      border-color: #A0522D;
      box-shadow: 0 0 0 3px rgba(160,82,45,.15);}
    .modal-content .btn {
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      font-size: 1.1rem;}
    /* 修改後的提示文字樣式 */
    .prompt-text { /* 使用更通用的類名 */
      margin-top: 20px;
      font-size: 0.95rem;
      color: #666;
    }
    .action-link { /* 使用更通用的類名 */
      color: #A0522D; /* 鏈接顏色與主題色保持一致 */
      font-weight: bold;
      text-decoration: none;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .action-link:hover {
      color: #CD853F;
      text-decoration: underline;
    }
    /* 資安提示樣式 */
    .security-note {
      font-size: 0.85rem;
      color: #888;
      margin-top: 25px;
      margin-bottom: 20px;
      line-height: 1.5;
    }


    .knowledge-section {
      margin-bottom: 30px;
    }
    /* 酒類知識區塊樣式 */
    .knowledge-section h2 {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #555;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }
    .knowledge-section h2::before {
      content: '💡'; /* 小燈泡圖標 */
      font-size: 1.3em; /* 調整圖標大小 */
      margin-right: 5px;
    }
    .knowledge-section .knowledge-content {
      min-height: 60px; /* 稍減最小高度，從 80px 調整為 60px */
      display: flex; /* 使用 flexbox 讓內容垂直居中 */
      align-items: center; /* 垂直居中 */
      justify-content: center; /* 水平居中 */
      text-align: center; /* 確保文本居中 */
    }
    .knowledge-section p {
      margin-bottom: 10px;
      line-height: 1.6;
      color: #666;
      opacity: 0; /* 預設隱藏，用於過渡效果 */
      transition: opacity 0.5s ease-in-out; /* 淡入淡出效果 */
    }
    .knowledge-section p.active {
      opacity: 1; /* 顯示時淡入 */
    }

    /* 釣魚教育模態框的樣式 */
    .phishing-modal-content {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
      max-width: 600px;
      width: 90%;
      text-align: center;
      position: relative;
    }
    .phishing-modal-content h1 {
      color: #A0522D; /* 與主題色相符 */
      font-size: 2.2rem; /* 稍微縮小標題 */
      margin-bottom: 25px;
      font-weight: 700;
    }
    .phishing-modal-content p {
      font-size: 1.05rem; /* 稍微縮小文字 */
      line-height: 1.7;
      margin-bottom: 20px;
      color: #555;
    }
    .phishing-modal-content .highlight {
      font-weight: bold;
      color: #DC143C; /* 醒目紅色 */
    }
    .phishing-modal-content .back-to-main-btn {
      display: inline-block;
      margin-top: 30px;
      padding: 12px 25px;
      background: linear-gradient(45deg, #CD853F, #EEE8AA); /* 按鈕漸變色 */
      color: white;
      text-decoration: none;
      border: none; /* 移除邊框 */
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .phishing-modal-content .back-to-main-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(160, 82, 45, 0.3);
    }

    /* 新增的管理員登入按鈕樣式 */
    .admin-login-btn {
      display: inline-block;
      margin-top: 15px;
      padding: 10px 20px;
      background: #A0522D; /* 深棕色 */
      color: white;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .admin-login-btn:hover {
      background: #8B4513; /* 更深的棕色 */
    }


    @media (max-width: 768px) {
      .phishing-modal-content h1 {
        font-size: 1.8rem;
      }
      .phishing-modal-content p {
        font-size: 0.95rem;
      }
      .phishing-modal-content {
        padding: 30px;
      }
    }

  </style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1 class="main-title">酒類價格查詢系統</h1>
    <p class="subtitle">Professional Alcohol Price Management System</p>
  </div>

  <div id="statsSection" class="stats-grid">
  </div>

  <div class="chart-section">
    <div class="chart-controls">
      <label>年份範圍：</label>
      <select id="chartYearStart"></select>
      <span>至</span>
      <select id="chartYearEnd"></select>
      <button class="btn" onclick="updateChart()">更新圖表</button>
    </div>

    <div class="chart-alcohol-checkboxes" id="alcoholTypeCheckboxes">
    </div>

    <div class="chart-container">
      <canvas id="priceChart"></canvas>
    </div>
  </div>

  <div class="card knowledge-section">
    <h2>🍷 酒類小知識</h2>
    <div id="knowledgeContent" class="knowledge-content">
    </div>
    <div style="text-align: center; margin-top: 20px;">
      <button id="unlockKnowledgeBtn" class="btn" onclick="showLoginPrompt('phishing')">登入以解鎖更多酒類知識</button>
      <button class="admin-login-btn" onclick="showLoginPrompt('admin')">管理員登入</button>
    </div>
  </div>


  <div class="dashboard">
    <div class="card">
      <h2>查詢酒價資料</h2>
      <form id="searchForm" onsubmit="return false;">
        <table class="form-table">
          <tr>
            <th>年份</th>
            <th>月份</th>
            <th>酒</th>
            <th>米酒</th>
            <th>啤酒</th>
            <th>高粱酒</th>
            <th>其他酒</th>
            <th></th>
          </tr>
          <tr>
            <td><select name="year" id="searchYear"></select></td>
            <td><select name="month" id="searchMonth"></select></td>
            <td><input type="number" step="0.01" name="price_14" placeholder="價格查詢"></td>
            <td><input type="number" step="0.01" name="price_133" placeholder="價格查詢"></td>
            <td><input type="number" step="0.01" name="price_134" placeholder="價格查詢"></td>
            <td><input type="number" step="0.01" name="price_135" placeholder="價格查詢"></td>
            <td><input type="number" step="0.01" name="price_136" placeholder="價格查詢"></td>
            <td><button type="submit" class="btn">查詢</button></td>
          </tr>
        </table>
      </form>
      <div id="searchMsg"></div>
    </div>

    <div class="card" id="addPriceCard" style="display: none;">
      <h2>新增酒價資料</h2>
      <form id="priceForm" onsubmit="return false;">
        <table class="form-table">
          <tr>
            <th>年份</th>
            <th>月份</th>
            <th>酒</th>
            <th>米酒</th>
            <th>啤酒</th>
            <th>高粱酒</th>
            <th>其他酒</th>
            <th></th>
          </tr>
          <tr>
            <td><select name="year" id="addYear" required></select></td>
            <td><select name="month" id="addMonth"><option value=""></option></select></td>
            <td><input type="text" name="price_14" placeholder="價格新增"></td>
            <td><input type="text" name="price_133" placeholder="價格新增"></td>
            <td><input type="text" name="price_134" placeholder="價格新增"></td>
            <td><input type="text" name="price_135" placeholder="價格新增"></td>
            <td><input type="text" name="price_136" placeholder="價格新增"></td>
            <td><button type="submit" class="btn">送出</button></td>
          </tr>
        </table>
      </form>
      <div id="resultMsg"></div>
    </div>

    <div class="card data-table-section">
      <h2>酒類價格資料表</h2>
      <table id="pricesTable">
        <thead>
        <tr>
          <th>日期</th>
          <th>酒</th>
          <th>米酒</th>
          <th>啤酒</th>
          <th>高粱酒</th>
          <th>其他酒</th>
          <th>操作</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div id="loginModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <span class="close-button" onclick="closeLoginModal()">&times;</span>
    <h3 id="loginModalTitle">登入以解鎖更多酒類知識</h3>
    <p class="prompt-text" id="loginPromptText">沒有帳號? <a href="#" class="action-link" onclick="handleRegisterLink(event)">立即註冊</a></p>
    <form id="loginForm">
      <div class="form-group">
        <label for="username">帳號:</label>
        <input type="text" id="username" name="username" placeholder="請輸入帳號" required>
      </div>
      <div class="form-group">
        <label for="password">密碼:</label>
        <input type="password" id="password" name="password" placeholder="請輸入密碼" required>
      </div>
      <button type="submit" class="btn" id="loginSubmitBtn">登入</button>
    </form>
    <div id="loginMessage" class="message" style="display: none;"></div>
    <button class="btn" id="logoutButton" style="display: none; background: #dc3545;" onclick="logout()">登出</button>
  </div>
</div>

<!-- 新增：管理員驗證碼 Modal -->
<div id="adminVerifyModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <span class="close-button" onclick="closeAdminVerifyModal()">&times;</span>
    <h3>管理員二次驗證</h3>
    <form id="adminVerifyForm">
      <div class="form-group">
        <label for="adminVerifyCode">請輸入驗證碼：</label>
        <input type="text" id="adminVerifyCode" name="adminVerifyCode" placeholder="請輸入驗證碼" required>
      </div>
      <button type="submit" class="btn">驗證</button>
    </form>
    <div id="adminVerifyMsg" class="message" style="display:none;"></div>
    <p class="security-note"></p>
  </div>
</div>

<div id="registerModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <span class="close-button" onclick="closeRegisterModal()">&times;</span>
    <h3>註冊新帳號</h3>
    <p class="prompt-text">已經有帳號了? <a href="#" class="action-link" onclick="handleLoginLink(event)">返回登入</a></p>
    <form id="fakeRegisterForm">
      <div class="form-group">
        <label for="regUsername">帳號:</label>
        <input type="text" id="regUsername" name="regUsername" placeholder="請輸入您的帳號" required>
      </div>
      <div class="form-group">
        <label for="regPassword">密碼:</label>
        <input type="password" id="regPassword" name="regPassword" placeholder="請輸入您的密碼" required>
      </div>
      <div class="form-group">
        <label for="confirmPassword">確認密碼:</label>
        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="請再次輸入密碼" required>
      </div>
      <button type="submit" class="btn">立即註冊</button>
    </form>
    <div id="registerMessage" class="message" style="display: none;"></div>
  </div>
</div>

<div id="phishingEducationModal" class="modal-overlay" style="display: none;">
  <div class="phishing-modal-content">
    <span class="close-button" onclick="closePhishingEducationModal()">&times;</span>
    <h1>資安教育模擬：釣魚攻擊警示！</h1>
    <p>恭喜您，這是一個<span class="highlight">模擬的釣魚網站頁面</span>！</p>
    <p>
      您剛才輸入的帳號密碼，如果是在真實的釣魚網站上，將會被惡意人士竊取。
    </p>
    <p>
      這個練習旨在提醒您在點擊連結和輸入個人資訊（尤其是帳號密碼）之前，務必<span class="highlight">仔細檢查網址和網站的真實性</span>。
    </p>
    <p>
      <span class="highlight">請勿在任何可疑網站上輸入您的真實帳號密碼！</span>
    </p>
    <button class="back-to-main-btn" onclick="closePhishingEducationModal()">返回酒類價格查詢系統</button>
  </div>
</div>


<script>
  let allData = [];
  let priceChart = null;
  let currentLoginMode = ''; // 'phishing' 或 'admin'

  const alcoholTypes = [
    { key: '酒', label: '酒', dbField: 'price_14' },
    { key: '米酒', label: '米酒', dbField: 'price_133' },
    { key: '啤酒', label: '啤酒', dbField: 'price_134' },
    { key: '高粱酒', label: '高粱酒', dbField: 'price_135' },
    { key: '其他酒', label: '其他酒', dbField: 'price_136' }
  ];

  const chartColors = [
    'rgb(160,82,45)',   // 酒
    'rgb(210,180,140)', // 米酒
    'rgb(139,69,19)',   // 啤酒
    'rgb(255,193,7)',   // 高粱酒
    'rgb(188,143,143)', // 其他酒
    'rgb(205,133,63)',
    'rgb(244,164,96)',
    'rgb(101,67,33)',
    'rgb(240,230,140)',
    'rgb(238,232,170)'
  ];

  // 酒類小知識陣列
  const alcoholKnowledges = [
    "你知道嗎？世界上最古老的酒類並非葡萄酒或啤酒，而是蜂蜜酒（Mead），其歷史可追溯至公元前7000年，比葡萄酒早了至少數千年！",
    "為什麼有些葡萄酒越陳越香？這是因為葡萄酒中的單寧、酸度、糖分和酒精在瓶中會緩慢發生化學反應，產生更複雜的香氣和口感。並非所有葡萄酒都適合陳年喔！",
    "高粱酒是台灣獨特的白酒，其釀造過程中使用固態發酵與開放式發酵，再經過多次蒸餾和長期地窖儲存，才得以形成其獨特的醇厚風味。",
    "啤酒的發酵過程分為頂層發酵（ale）和底層發酵（lager）。艾爾啤酒通常在較高溫度下發酵，口感豐富；拉格啤酒則在較低溫度下發酵，口感清爽。",
    "威士忌的風味很大程度上取決於其陳年所用的木桶類型，尤其是橡木桶。新桶、波特桶、雪莉桶等都會賦予威士忌不同的香氣和顏色。",
    "伏特加雖然常被認為是無色無味的烈酒，但優質的伏特加在原料選擇和蒸餾工藝上仍有很大講究，能呈現出不同的細膩風味。",
    "日本清酒的等級區分非常細緻，主要依據精米步合（糙米磨去外部的比例）和是否添加釀造酒精來分類，例如大吟釀、純米吟釀等。"
  ];
  let currentKnowledgeIndex = 0;
  let knowledgeInterval;

  function displayNextKnowledge() {
    const knowledgeContentDiv = document.getElementById('knowledgeContent');
    const oldParagraph = knowledgeContentDiv.querySelector('p');
    if (oldParagraph) {
      oldParagraph.classList.remove('active');
      setTimeout(() => {
        if (oldParagraph && oldParagraph.parentNode) {
          oldParagraph.parentNode.removeChild(oldParagraph);
        }
      }, 500);
    }

    setTimeout(() => {
      const newParagraph = document.createElement('p');
      newParagraph.textContent = alcoholKnowledges[currentKnowledgeIndex];
      knowledgeContentDiv.appendChild(newParagraph);
      void newParagraph.offsetWidth;
      newParagraph.classList.add('active');
      currentKnowledgeIndex = (currentKnowledgeIndex + 1) % alcoholKnowledges.length;
    }, oldParagraph ? 500 : 0);
  }

  function startKnowledgeCarousel() {
    if (document.getElementById('loginModal').style.display === 'none' &&
            document.getElementById('registerModal').style.display === 'none' &&
            document.getElementById('phishingEducationModal').style.display === 'none') {
      if (!knowledgeInterval) {
        displayNextKnowledge();
        knowledgeInterval = setInterval(displayNextKnowledge, 10000);
      }
    }
  }

  function stopKnowledgeCarousel() {
    if (knowledgeInterval) {
      clearInterval(knowledgeInterval);
      knowledgeInterval = null;
    }
  }

  // 檢查是否為管理員（不再依賴 JWT，而是 localStorage）
  function isAdmin() {
    return localStorage.getItem('isAdminLoggedIn') === 'true';
  }

  // 更新 UI 元素的可見性
  function updateUIForAdminStatus() {
    const addPriceCard = document.getElementById('addPriceCard');
    const deleteButtons = document.querySelectorAll('#pricesTable .delete-btn');
    const logoutButton = document.getElementById('logoutButton');
    const unlockKnowledgeBtn = document.getElementById('unlockKnowledgeBtn');
    const adminLoginBtn = document.querySelector('.admin-login-btn');

    if (isAdmin()) {
      addPriceCard.style.display = 'block'; // 顯示新增卡片
      deleteButtons.forEach(btn => btn.classList.remove('hidden')); // 顯示刪除按鈕
      logoutButton.style.display = 'block'; // 顯示登出按鈕
      if (unlockKnowledgeBtn) unlockKnowledgeBtn.style.display = 'none'; // 管理員登入後隱藏知識解鎖按鈕
      if (adminLoginBtn) {
        adminLoginBtn.textContent = '管理員登出';
        adminLoginBtn.onclick = logout;
      }
      // 如果管理員已登入，隱藏登入模態框中的登入按鈕
      document.getElementById('loginSubmitBtn').style.display = 'none';
      document.getElementById('loginPromptText').style.display = 'none'; // 隱藏註冊連結
    } else {
      addPriceCard.style.display = 'none'; // 隱藏新增卡片
      deleteButtons.forEach(btn => btn.classList.add('hidden')); // 隱藏刪除按鈕
      logoutButton.style.display = 'none'; // 隱藏登出按鈕
      if (unlockKnowledgeBtn) unlockKnowledgeBtn.style.display = 'inline-block'; // 非管理員顯示知識解鎖按鈕
      if (adminLoginBtn) {
        adminLoginBtn.textContent = '管理員登入';
        adminLoginBtn.onclick = function() { showLoginPrompt('admin'); };
      }
      // 如果不是管理員，顯示登入模態框中的登入按鈕和註冊連結
      document.getElementById('loginSubmitBtn').style.display = 'block';
      document.getElementById('loginPromptText').style.display = 'block';
    }
  }

  // 登出功能
  function logout() {
    localStorage.removeItem('isAdminLoggedIn'); // 移除管理員標誌
    updateUIForAdminStatus(); // 更新 UI
    alert('您已登出管理員帳號。');
    closeLoginModal(); // 關閉模態框
  }

  // 顯示登入模態框
  function showLoginPrompt(mode) {
    currentLoginMode = mode;
    const loginModal = document.getElementById('loginModal');
    const loginModalTitle = document.getElementById('loginModalTitle');
    const loginPromptText = document.getElementById('loginPromptText');
    const logoutButton = document.getElementById('logoutButton');

    if (mode === 'phishing') {
      loginModalTitle.textContent = '登入以解鎖更多酒類知識';
      loginPromptText.style.display = 'block';
      logoutButton.style.display = 'none'; // 釣魚模式不顯示登出按鈕
      document.getElementById('loginSubmitBtn').style.display = 'block'; // 釣魚模式顯示登入按鈕
    } else if (mode === 'admin') {
      loginModalTitle.textContent = '管理員登入';
      // 如果已登入管理員，則顯示登出按鈕並隱藏登入表單
      if (isAdmin()) {
        loginPromptText.style.display = 'none';
        logoutButton.style.display = 'block';
        document.getElementById('loginForm').style.display = 'none'; // 隱藏表單
        document.getElementById('loginMessage').textContent = '您已登入管理員帳號。';
        document.getElementById('loginMessage').className = 'message info';
        document.getElementById('loginMessage').style.display = 'block';
      } else {
        loginPromptText.style.display = 'none';
        logoutButton.style.display = 'none';
        document.getElementById('loginForm').style.display = 'block'; // 顯示表單
        document.getElementById('loginMessage').style.display = 'none';
        document.getElementById('loginSubmitBtn').style.display = 'block';
      }
    }
    loginModal.style.display = 'flex';
    stopKnowledgeCarousel(); // 暫停知識輪播
  }


  // 關閉登入模態框
  function closeLoginModal() {
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('loginForm').reset();
    document.getElementById('loginMessage').style.display = 'none';
    startKnowledgeCarousel(); // 恢復知識輪播
  }

  // 關閉註冊模態框
  function closeRegisterModal() {
    document.getElementById('registerModal').style.display = 'none';
    document.getElementById('fakeRegisterForm').reset();
    document.getElementById('registerMessage').style.display = 'none';
    startKnowledgeCarousel(); // 恢復知識輪播
  }

  // 關閉釣魚教育模態框
  function closePhishingEducationModal() {
    document.getElementById('phishingEducationModal').style.display = 'none';
    startKnowledgeCarousel(); // 恢復知識輪播
  }

  // 處理「立即註冊」連結
  function handleRegisterLink(event) {
    event.preventDefault();
    closeLoginModal(); // 關閉登入框
    document.getElementById('registerModal').style.display = 'flex'; // 顯示註冊框
    stopKnowledgeCarousel(); // 暫停知識輪播
  }

  // 處理「返回登入」連結
  function handleLoginLink(event) {
    event.preventDefault();
    closeRegisterModal(); // 關閉註冊框
    showLoginPrompt(currentLoginMode); // 重新顯示登入框，保留模式
    stopKnowledgeCarousel(); // 暫停知識輪播
  }

  // 模擬註冊表單提交
  document.getElementById('fakeRegisterForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const regUsername = document.getElementById('regUsername').value;
    const regPassword = document.getElementById('regPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const registerMessage = document.getElementById('registerMessage');

    if (regPassword !== confirmPassword) {
      registerMessage.textContent = '密碼與確認密碼不一致！';
      registerMessage.className = 'message error';
      registerMessage.style.display = 'block';
      return;
    }

    // 在這裡，你可以模擬註冊成功的行為，例如彈出提示
    registerMessage.textContent = `註冊成功！帳號: ${regUsername}`;
    registerMessage.className = 'message success';
    registerMessage.style.display = 'block';
    // 可以選擇性地自動關閉註冊框並打開登入框
    setTimeout(() => {
      closeRegisterModal();
      showLoginPrompt('phishing'); // 返回釣魚模式的登入框
    }, 2000);
  });


  // 處理登入表單提交
  document.getElementById('loginForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginMessage = document.getElementById('loginMessage');
    const username = usernameInput.value;
    const password = passwordInput.value;

    loginMessage.style.display = 'none'; // 清除之前的訊息

    if (currentLoginMode === 'phishing') {
      // 模擬釣魚網站的行為：無論輸入什麼都「成功」
      console.log('網站登入:', { username, password });
      loginMessage.textContent = '登入成功！正在為您解鎖酒類知識...';
      loginMessage.className = 'message success';
      loginMessage.style.display = 'block';
      setTimeout(() => {
        closeLoginModal();
        document.getElementById('phishingEducationModal').style.display = 'flex'; // 顯示資安教育彈窗
      }, 1500);
    } else if (currentLoginMode === 'admin') {
      // 管理員登入
      try {
        const response = await fetch('/api/adminLogin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (response.ok && data.isAdmin) {
          // 顯示二次驗證 modal
          closeLoginModal();
          showAdminVerifyModal();
        } else {
          loginMessage.textContent = data.message || '登入失敗，請檢查帳號密碼。';
          loginMessage.className = 'message error';
          loginMessage.style.display = 'block';
          localStorage.removeItem('isAdminLoggedIn'); // 確保移除錯誤狀態
          updateUIForAdminStatus(); // 更新 UI
        }
      } catch (error) {
        console.error('管理員登入錯誤:', error);
        loginMessage.textContent = '登入時發生錯誤，請稍後再試。';
        loginMessage.className = 'message error';
        loginMessage.style.display = 'block';
        localStorage.removeItem('isAdminLoggedIn');
        updateUIForAdminStatus();
      }
    }
  });

  // 管理員二次驗證流程
  function showAdminVerifyModal() {
    document.getElementById('adminVerifyCode').value = '';
    document.getElementById('adminVerifyMsg').style.display = 'none';
    document.getElementById('adminVerifyModal').style.display = 'flex';
  }
  function closeAdminVerifyModal() {
    document.getElementById('adminVerifyModal').style.display = 'none';
  }

  // 驗證碼表單提交
  const adminVerifyForm = document.getElementById('adminVerifyForm');
  if (adminVerifyForm) {
    adminVerifyForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const code = document.getElementById('adminVerifyCode').value;
      if (code === '123456') {
        // 設定管理員登入狀態
        localStorage.setItem('isAdminLoggedIn', 'true');
        closeAdminVerifyModal();
        updateUIForAdminStatus();
        alert('管理員登入成功！');
      } else {
        document.getElementById('adminVerifyMsg').textContent = '驗證碼錯誤，請重新輸入';
        document.getElementById('adminVerifyMsg').className = 'message error';
        document.getElementById('adminVerifyMsg').style.display = 'block';
      }
    });
  }

  async function loadPrices(query = null) {
    try {
      let options = {
        method: 'POST', // 調整為 POST 以支援篩選
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(query || {}) // 傳遞查詢參數
      };

      const res = await fetch('/api/prices', options);

      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }

      const data = await res.json();
      console.log('從後端載入的數據:', data);

      if (!Array.isArray(data)) {
        console.warn('後端返回的數據格式不是陣列:', data);
        data = []; // 確保 data 是一個陣列
      }

      allData = data;
      displayData(data);
      updateStats(data);
      if (data.length > 0) {
        updateChart();
      }
      updateUIForAdminStatus(); // 載入數據后更新 UI 權限狀態
    } catch (error) {
      console.error('載入數據時發生錯誤:', error);
      showMessage(`載入數據時發生錯誤: ${error.message}，請確保後端伺服器已運行`, 'error');
      displayData([]); // 顯示空數據
      updateStats([]); // 更新統計為空
    }
  }

  function displayData(data) {
    const tbody = document.querySelector('#pricesTable tbody');
    tbody.innerHTML = '';
    if (!data || data.length === 0) {
      document.getElementById('searchMsg').innerHTML = '<div class="message error">查無資料</div>';
      return;
    }
    document.getElementById('searchMsg').innerHTML = '';
    data.forEach((row, index) => {
      try {
        const tr = document.createElement('tr');
        const date = row.date || '';

        // 顯示欄位為 null、空字串或 "-" 時，顯示 "-"，否則顯示原值
        function showValue(val) {
          return (val === null || val === undefined || val === '' || val === '-') ? '-' : val;
        }

        tr.innerHTML = `
            <td>${date}</td>
            <td>${showValue(row.酒)}</td>
            <td>${showValue(row.米酒)}</td>
            <td>${showValue(row.啤酒)}</td>
            <td>${showValue(row.高粱酒)}</td>
            <td>${showValue(row.其他酒)}</td>
            <td><button class='btn btn-danger delete-btn ${isAdmin() ? '' : 'hidden'}'>刪除</button></td>
          `;
        const deleteBtn = tr.querySelector('.delete-btn');
        deleteBtn.onclick = async function() {
          if (!isAdmin()) { // 在前端再次檢查權限
            showMessage('您沒有權限執行此操作，請先登入管理員帳號！', 'error');
            return;
          }
          if (confirm('確定要刪除這筆資料嗎？')) {
            try {
              const response = await fetch('/api/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date: date })
              });

              if (response.ok) {
                const msg = await response.text();
                showMessage(msg, 'success');
                loadPrices(); // 重新載入數據
              } else {
                const errorText = await response.text();
                throw new Error(`刪除失敗: HTTP ${response.status} - ${errorText}`);
              }
            } catch (error) {
              console.error('刪除錯誤:', error);
              showMessage(`刪除失敗: ${error.message}`, 'error');
            }
          }
        };
        tbody.appendChild(tr);
      } catch (error) {
        console.error(`處理第${index}筆數據時發生錯誤:`, error, row);
      }
    });
    updateUIForAdminStatus(); // 確保刪除按鈕權限更新
  }

  function animateNumber(element, start, end, duration) {
    let startTime = null;
    function easeInOutQuad(t) {
      return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
    }
    function animate(currentTime) {
      if (!startTime) startTime = currentTime;
      const progress = Math.min((currentTime - startTime) / duration, 1);
      const easedProgress = easeInOutQuad(progress);
      const current = start + (end - start) * easedProgress;
      if (element.classList.contains('float-number')) {
        element.textContent = current.toFixed(2);
      } else {
        element.textContent = Math.floor(current);
      }
      if (progress < 1) {
        requestAnimationFrame(animate);
      }
    }
    requestAnimationFrame(animate);
  }

  function updateStats(data) {
    const statsSection = document.getElementById('statsSection');
    if (!data || data.length === 0) {
      statsSection.innerHTML = '<div class="stat-card"><div class="stat-number">0</div><div class="stat-label">暫無數據</div></div>';
      return;
    }
    try {
      const prices = {};
      alcoholTypes.forEach(type => {
        prices[type.label] = [];
      });

      data.forEach(item => {
        alcoholTypes.forEach(type => {
          const value = parseFloat(item[type.label] || 0);
          if (!isNaN(value) && value > 0) {
            prices[type.label].push(value);
          }
        });
      });

      statsSection.innerHTML = ''; // 清空舊的統計卡片
      alcoholTypes.forEach(type => {
        const avgPrice = prices[type.label].length > 0 ? (prices[type.label].reduce((a, b) => a + b, 0) / prices[type.label].length) : 0;
        const statCard = document.createElement('div');
        statCard.className = 'stat-card';
        statCard.innerHTML = `
          <div class="stat-number float-number" data-target="${avgPrice.toFixed(2)}">0.00</div>
          <div class="stat-label">${type.label}平均價格</div>
        `;
        statsSection.appendChild(statCard);
      });

      // 總筆數
      const totalCountCard = document.createElement('div');
      totalCountCard.className = 'stat-card';
      totalCountCard.innerHTML = `
        <div class="stat-number integer-number" data-target="${data.length}">0</div>
        <div class="stat-label">總筆數</div>
      `;
      statsSection.appendChild(totalCountCard);

      document.querySelectorAll('.stat-number').forEach(element => {
        const target = parseFloat(element.getAttribute('data-target'));
        const isFloat = element.classList.contains('float-number');
        const startValue = isFloat ? 0.00 : 0;
        animateNumber(element, startValue, target, 1000);
      });
    } catch (error) {
      console.error('統計計算錯誤:', error);
      statsSection.innerHTML = '<div class="stat-card"><div class="stat-number">錯誤</div><div class="stat-label">統計計算失敗</div></div>';
    }
  }


  function initChart() {
    const ctx = document.getElementById('priceChart').getContext('2d');
    priceChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: []
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: '酒類價格趨勢'
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: '時間'
            }
          },
          y: {
            title: {
              display: true,
              text: '價格 (NT$)'
            }
          }
        }
      }
    });
  }

  function updateChart() {
    if (!allData || allData.length === 0) {
      console.log('沒有數據可以繪製圖表');
      if (priceChart) {
        priceChart.data.labels = [];
        priceChart.data.datasets = [];
        priceChart.update();
      }
      return;
    }
    try {
      const selectedAlcoholTypes = Array.from(document.querySelectorAll('#alcoholTypeCheckboxes input[type="checkbox"]:checked'))
              .map(checkbox => checkbox.value);
      if (selectedAlcoholTypes.length === 0) {
        console.log('請至少選擇一種酒類來繪製圖表');
        if (priceChart) {
          priceChart.data.labels = [];
          priceChart.data.datasets = [];
          priceChart.update();
        }
        return;
      }
      const yearStart = parseInt(document.getElementById('chartYearStart').value) || 70;
      const yearEnd = parseInt(document.getElementById('chartYearEnd').value) || 114;

      const filteredData = allData.filter(item => {
        const dateStr = item.date || '';
        const yearMatch = dateStr.match(/(\d+)年/);
        if (!yearMatch) return false;
        const year = parseInt(yearMatch[1]);
        return year >= yearStart && year <= yearEnd;
      }).sort((a, b) => {
        const dateA = a.date || '';
        const dateB = b.date || '';

        const yearA = parseInt((dateA.match(/(\d+)年/) || [0, 0])[1]);
        const monthA = parseInt((dateA.match(/(\d+)月/) || [0, 0])[1]);
        const yearB = parseInt((dateB.match(/(\d+)年/) || [0, 0])[1]);
        const monthB = parseInt((dateB.match(/(\d+)月/) || [0, 0])[1]);

        if (yearA !== yearB) return yearA - yearB;
        return monthA - monthB;
      });

      if (filteredData.length === 0) {
        console.log('篩選後沒有數據');
        if (priceChart) {
          priceChart.data.labels = [];
          priceChart.data.datasets = [];
          priceChart.update();
        }
        return;
      }

      const labels = filteredData.map(item => item.date || '');
      const datasets = [];

      selectedAlcoholTypes.forEach((typeLabel, index) => {
        const prices = filteredData.map(item => {
          let value = parseFloat(item[typeLabel] || 0); // 使用 typeLabel, 因為數據是 '酒', '米酒'
          return isNaN(value) ? 0 : value;
        });
        const colorIndex = index % chartColors.length;
        const borderColor = chartColors[colorIndex];
        const backgroundColor = borderColor.replace('rgb', 'rgba').replace(')', ', 0.1)');
        datasets.push({
          label: `${typeLabel}價格`,
          data: prices,
          borderColor: borderColor,
          backgroundColor: backgroundColor,
          tension: 0.4,
          fill: false,
          pointRadius: 3,
          pointHoverRadius: 5
        });
      });
      if (priceChart) {
        priceChart.data.labels = labels;
        priceChart.data.datasets = datasets;
        priceChart.update();
      }
    } catch (error) {
      console.error('圖表更新錯誤:', error);
    }
  }

  function showMessage(text, type = 'success') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.textContent = text;
    let targetMsgDiv = null;

    // 根據當前顯示的模態框類型來決定訊息顯示位置
    if (document.getElementById('loginModal').style.display === 'flex') {
      targetMsgDiv = document.getElementById('loginMessage');
    } else if (document.getElementById('registerModal').style.display === 'flex') {
      targetMsgDiv = document.getElementById('registerMessage');
    } else {
      // 如果沒有模態框顯示，則訊息顯示在新增/查詢表單下方
      targetMsgDiv = document.getElementById('resultMsg');
      if (targetMsgDiv.style.display === 'none') {
        targetMsgDiv = document.getElementById('searchMsg'); // 或者 searchMsg
      }
    }

    if (targetMsgDiv) {
      targetMsgDiv.innerHTML = '';
      targetMsgDiv.appendChild(messageDiv);
      targetMsgDiv.style.display = 'block';
      setTimeout(() => {
        messageDiv.remove();
        if (targetMsgDiv.children.length === 0) { // 如果沒有其他訊息了，才隱藏 div
          targetMsgDiv.style.display = 'none';
        }
      }, 3000);
    } else {
      console.warn('無法找到顯示訊息的目標 div:', text, type);
    }
  }


  function fillYearMonth(yearId, monthId, required = false) {
    const yearSel = document.getElementById(yearId);
    const monthSel = document.getElementById(monthId);
    yearSel.innerHTML = '';
    monthSel.innerHTML = '';
    if (!required) {
      const emptyYearOpt = document.createElement('option');
      emptyYearOpt.value = '';
      emptyYearOpt.textContent = '選擇年份';
      yearSel.appendChild(emptyYearOpt);
    }
    for (let y = 70; y <= 114; y++) {
      const opt = document.createElement('option');
      opt.value = y;
      opt.textContent = `民國${y}年`;
      yearSel.appendChild(opt);
    }
    if (!required) {
      const emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.textContent = '選擇月份';
      monthSel.appendChild(emptyOpt);
    }
    for (let m = 1; m <= 12; m++) {
      const opt = document.createElement('option');
      opt.value = m.toString().padStart(2, '0');
      opt.textContent = `${m}月`;
      monthSel.appendChild(opt);
    }
  }

  function fillChartYearSelects() {
    const startSelect = document.getElementById('chartYearStart');
    const endSelect = document.getElementById('chartYearEnd');
    // 清空現有選項
    startSelect.innerHTML = '';
    endSelect.innerHTML = '';

    for (let y = 70; y <= 114; y++) {
      const startOpt = document.createElement('option');
      startOpt.value = y;
      startOpt.textContent = `民國${y}年`;
      startSelect.appendChild(startOpt);

      const endOpt = document.createElement('option');
      endOpt.value = y;
      endOpt.textContent = `民國${y}年`;
      endSelect.appendChild(endOpt);
    }
    // 預設選取最新年份範圍
    startSelect.value = 100;
    endSelect.value = 114;
  }

  function createAlcoholTypeCheckboxes() {
    const checkboxContainer = document.getElementById('alcoholTypeCheckboxes');
    checkboxContainer.innerHTML = '';
    alcoholTypes.forEach((type, index) => {
      const label = document.createElement('label');
      label.innerHTML = `
        <input type="checkbox" value="${type.label}" ${index === 0 ? 'checked' : ''}>
        <span class="color-box" style="background-color: ${chartColors[index % chartColors.length]};"></span>
        ${type.label}
      `;
      checkboxContainer.appendChild(label);
    });

    checkboxContainer.addEventListener('change', updateChart);
  }

  // 處理新增酒價表單提交
  document.getElementById('priceForm').addEventListener('submit', async function() {
    const form = this;
    const year = form.year.value;
    const month = form.month.value;
    const date = `${year}年${parseInt(month, 10)}月`; // 確保月份沒有前導零，以符合後端處理

    const body = {
      date: date,
      price_14: form.price_14.value,
      price_133: form.price_133.value,
      price_134: form.price_134.value,
      price_135: form.price_135.value,
      price_136: form.price_136.value
    };

    if (!isAdmin()) { // 再次在前端檢查權限
      showMessage('您沒有權限執行此操作，請先登入管理員帳號！', 'error');
      return;
    }

    try {
      const res = await fetch('/api/insert', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (res.ok) {
        const msg = await res.text();
        showMessage(msg, 'success');
        form.reset();
        loadPrices();
      } else {
        const errorText = await res.text(); // 取得錯誤訊息
        throw new Error(`新增失敗: HTTP ${res.status} - ${errorText}`);
      }
    } catch (error) {
      console.error('新增數據錯誤:', error);
      showMessage(`新增失敗: ${error.message}`, 'error');
    }
  });

  // 處理查詢酒價表單提交
  document.getElementById('searchForm').addEventListener('submit', async function() {
    const form = this;
    const year = form.year.value;
    const month = form.month.value;
    let date = '';

    if (year && month) date = `${year}年${parseInt(month, 10)}月`;
    else if (year) date = `${year}年`;
    else if (month) date = `${parseInt(month, 10)}月`; // 單獨月份查詢可能需要後端支持

    const query = {};
    if (date) query.date = date;
    // 只有當輸入框有值時才加入查詢條件，這樣可以實現模糊查詢
    if (form.price_14.value) query.price_14 = form.price_14.value;
    if (form.price_133.value) query.price_133 = form.price_133.value;
    if (form.price_134.value) query.price_134 = form.price_134.value;
    if (form.price_135.value) query.price_135 = form.price_135.value;
    if (form.price_136.value) query.price_136 = form.price_136.value;

    // 傳遞 query 物件給 loadPrices
    await loadPrices(query);
  });

  // 初始化所有元素
  document.addEventListener('DOMContentLoaded', function() {
    fillYearMonth('addYear', 'addMonth', true); // 新增表單的年月是必填
    fillYearMonth('searchYear', 'searchMonth'); // 查詢表單的年月是選填
    fillChartYearSelects(); // 填充圖表年份選擇器
    createAlcoholTypeCheckboxes(); // 建立酒類圖表篩選 checkbox
    initChart(); // 初始化圖表
    loadPrices(); // 首次載入所有數據
    updateUIForAdminStatus(); // 首次載入後更新 UI 權限狀態
    startKnowledgeCarousel(); // 啟動酒類知識輪播
  });

</script>
</body>
</html>

